<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mock API æ¸¬è©¦ - CBON</title>
  <style>
    body { 
      background: #0f1115; 
      color: #fff; 
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
    }
    .card { 
      background: rgba(255,255,255,0.06); 
      border: 1px solid rgba(255,255,255,0.12); 
      border-radius: 16px; 
      padding: 20px; 
      margin: 20px 0;
    }
    .btn { 
      display: inline-flex; 
      align-items: center; 
      gap: 8px; 
      padding: 12px 20px; 
      border-radius: 10px; 
      border: none; 
      background: linear-gradient(135deg,#4285F4,#34A853); 
      color: white; 
      cursor: pointer; 
      font-weight: 600;
      margin: 5px;
    }
    .success { background: rgba(34,197,94,0.2); color: #22c55e; padding: 10px; border-radius: 8px; margin: 10px 0; }
    .error { background: rgba(239,68,68,0.2); color: #ef4444; padding: 10px; border-radius: 8px; margin: 10px 0; }
    .info { background: rgba(59,130,246,0.2); color: #3b82f6; padding: 10px; border-radius: 8px; margin: 10px 0; }
    .code { 
      background: rgba(0,0,0,0.3); 
      padding: 10px; 
      border-radius: 8px; 
      font-family: monospace; 
      font-size: 12px; 
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <h1>ğŸ§ª Mock API åŠŸèƒ½æ¸¬è©¦</h1>
  
  <div class="card">
    <h3>API ç‹€æ…‹æª¢æŸ¥</h3>
    <button id="healthBtn" class="btn">ğŸ” æª¢æŸ¥å¥åº·ç‹€æ…‹</button>
    <button id="statusBtn" class="btn">ğŸ“Š æŸ¥çœ‹Mockç‹€æ…‹</button>
    <div id="healthResult"></div>
  </div>
  
  <div class="card">
    <h3>æœƒå“¡è™Ÿç¢¼ç¶å®šæ¸¬è©¦</h3>
    
    <div>
      <h4>æ¸¬è©¦ç”¨æˆ¶: demo-user-12345</h4>
      <button id="checkBindingBtn" class="btn">ğŸ“‹ æª¢æŸ¥ç¶å®šç‹€æ…‹</button>
      <button id="bindBtn" class="btn">ğŸ”— ç¶å®šè™Ÿç¢¼ 0001</button>
      <button id="bindConflictBtn" class="btn">âš ï¸ æ¸¬è©¦è¡çªç¶å®š</button>
      <button id="unbindBtn" class="btn">ğŸ”“ è§£é™¤ç¶å®š</button>
    </div>
    
    <div id="bindingResult"></div>
  </div>
  
  <div class="card">
    <h3>æœƒå“¡æŸ¥æ‰¾æ¸¬è©¦</h3>
    <button id="findBtn" class="btn">ğŸ” æŸ¥æ‰¾æœƒå“¡ 0001</button>
    <button id="findNotExistBtn" class="btn">â“ æŸ¥æ‰¾ä¸å­˜åœ¨çš„æœƒå“¡</button>
    <div id="findResult"></div>
  </div>
  
  <div class="card">
    <h3>å®Œæ•´æµç¨‹æ¸¬è©¦</h3>
    <button id="fullTestBtn" class="btn">ğŸš€ é‹è¡Œå®Œæ•´æ¸¬è©¦</button>
    <div id="fullTestResult"></div>
  </div>

  <script type="module">
    // è¼‰å…¥æ¨¡æ“¬API
    await import('./js/mock-api.js');
    
    const APPS_SCRIPT_ENDPOINT = 'https://script.google.com/macros/s/test';
    
    function showResult(elementId, content, type = 'info') {
      const element = document.getElementById(elementId);
      element.innerHTML = `<div class="${type}">${content}</div>`;
    }
    
    function showCode(elementId, data) {
      const element = document.getElementById(elementId);
      element.innerHTML = `<div class="code">${JSON.stringify(data, null, 2)}</div>`;
    }

    // å¥åº·æª¢æŸ¥
    document.getElementById('healthBtn').addEventListener('click', async () => {
      try {
        const url = `${APPS_SCRIPT_ENDPOINT}?action=health&origin=${window.location.origin}`;
        const res = await fetch(url);
        const data = await res.json();
        
        if (data.ok) {
          showResult('healthResult', 'âœ… API æœå‹™æ­£å¸¸é‹è¡Œ', 'success');
          showCode('healthResult', data);
        } else {
          showResult('healthResult', 'âŒ API æœå‹™ç•°å¸¸', 'error');
          showCode('healthResult', data);
        }
      } catch (error) {
        showResult('healthResult', `âŒ é€£æ¥å¤±æ•—: ${error.message}`, 'error');
      }
    });

    // æŸ¥çœ‹Mockç‹€æ…‹
    document.getElementById('statusBtn').addEventListener('click', () => {
      if (window.mockAPI) {
        const status = window.mockAPI.getStatus();
        showResult('healthResult', 'ğŸ“Š Mock API ç‹€æ…‹', 'info');
        showCode('healthResult', status);
      } else {
        showResult('healthResult', 'âŒ Mock API æœªè¼‰å…¥', 'error');
      }
    });

    // æª¢æŸ¥ç¶å®šç‹€æ…‹
    document.getElementById('checkBindingBtn').addEventListener('click', async () => {
      try {
        const url = `${APPS_SCRIPT_ENDPOINT}?action=get_member_binding&uid=demo-user-12345&origin=${window.location.origin}`;
        const res = await fetch(url);
        const data = await res.json();
        
        if (data.ok) {
          if (data.bound) {
            showResult('bindingResult', `âœ… å·²ç¶å®šæœƒå“¡è™Ÿç¢¼: ${data.member_number}`, 'success');
          } else {
            showResult('bindingResult', 'ğŸ“‹ æœªç¶å®šæœƒå“¡è™Ÿç¢¼', 'info');
          }
          showCode('bindingResult', data);
        } else {
          showResult('bindingResult', 'âŒ æª¢æŸ¥å¤±æ•—', 'error');
          showCode('bindingResult', data);
        }
      } catch (error) {
        showResult('bindingResult', `âŒ æª¢æŸ¥å¤±æ•—: ${error.message}`, 'error');
      }
    });

    // ç¶å®šæœƒå“¡è™Ÿç¢¼
    document.getElementById('bindBtn').addEventListener('click', async () => {
      try {
        const url = `${APPS_SCRIPT_ENDPOINT}?action=bind_member_number&uid=demo-user-12345&member_number=0001&origin=${window.location.origin}`;
        const res = await fetch(url);
        const data = await res.json();
        
        if (data.ok) {
          showResult('bindingResult', `âœ… ç¶å®šæˆåŠŸ: ${data.member_number}`, 'success');
        } else {
          showResult('bindingResult', `âŒ ç¶å®šå¤±æ•—: ${data.error}`, 'error');
        }
        showCode('bindingResult', data);
      } catch (error) {
        showResult('bindingResult', `âŒ ç¶å®šå¤±æ•—: ${error.message}`, 'error');
      }
    });

    // æ¸¬è©¦è¡çªç¶å®š
    document.getElementById('bindConflictBtn').addEventListener('click', async () => {
      try {
        // å…ˆç¶å®šä¸€å€‹è™Ÿç¢¼çµ¦å¦ä¸€å€‹ç”¨æˆ¶
        await fetch(`${APPS_SCRIPT_ENDPOINT}?action=bind_member_number&uid=another-user&member_number=0002&origin=${window.location.origin}`);
        
        // ç„¶å¾Œå˜—è©¦ç”¨demoç”¨æˆ¶ç¶å®šåŒä¸€å€‹è™Ÿç¢¼
        const url = `${APPS_SCRIPT_ENDPOINT}?action=bind_member_number&uid=demo-user-12345&member_number=0002&origin=${window.location.origin}`;
        const res = await fetch(url);
        const data = await res.json();
        
        if (data.ok) {
          showResult('bindingResult', 'âŒ æ‡‰è©²å¤±æ•—ä½†æˆåŠŸäº†', 'error');
        } else {
          showResult('bindingResult', `âœ… æ­£ç¢ºæª¢æ¸¬åˆ°è¡çª: ${data.code}`, 'success');
        }
        showCode('bindingResult', data);
      } catch (error) {
        showResult('bindingResult', `âŒ æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
      }
    });

    // è§£é™¤ç¶å®š
    document.getElementById('unbindBtn').addEventListener('click', async () => {
      try {
        const url = `${APPS_SCRIPT_ENDPOINT}?action=unbind_member_number&uid=demo-user-12345&origin=${window.location.origin}`;
        const res = await fetch(url);
        const data = await res.json();
        
        if (data.ok) {
          showResult('bindingResult', 'âœ… è§£é™¤ç¶å®šæˆåŠŸ', 'success');
        } else {
          showResult('bindingResult', `âŒ è§£é™¤ç¶å®šå¤±æ•—: ${data.error}`, 'error');
        }
        showCode('bindingResult', data);
      } catch (error) {
        showResult('bindingResult', `âŒ è§£é™¤ç¶å®šå¤±æ•—: ${error.message}`, 'error');
      }
    });

    // æŸ¥æ‰¾æœƒå“¡
    document.getElementById('findBtn').addEventListener('click', async () => {
      try {
        const url = `${APPS_SCRIPT_ENDPOINT}?action=find_member_by_number&member_number=0001&origin=${window.location.origin}`;
        const res = await fetch(url);
        const data = await res.json();
        
        if (data.ok) {
          if (data.found) {
            showResult('findResult', `âœ… æ‰¾åˆ°æœƒå“¡: ${data.member.name}`, 'success');
          } else {
            showResult('findResult', 'ğŸ“‹ æœªæ‰¾åˆ°æœƒå“¡', 'info');
          }
          showCode('findResult', data);
        } else {
          showResult('findResult', 'âŒ æŸ¥æ‰¾å¤±æ•—', 'error');
          showCode('findResult', data);
        }
      } catch (error) {
        showResult('findResult', `âŒ æŸ¥æ‰¾å¤±æ•—: ${error.message}`, 'error');
      }
    });

    // æŸ¥æ‰¾ä¸å­˜åœ¨çš„æœƒå“¡
    document.getElementById('findNotExistBtn').addEventListener('click', async () => {
      try {
        const url = `${APPS_SCRIPT_ENDPOINT}?action=find_member_by_number&member_number=9999&origin=${window.location.origin}`;
        const res = await fetch(url);
        const data = await res.json();
        
        if (data.ok && !data.found) {
          showResult('findResult', 'âœ… æ­£ç¢ºè¿”å›æœªæ‰¾åˆ°', 'success');
        } else {
          showResult('findResult', 'âŒ æ‡‰è©²è¿”å›æœªæ‰¾åˆ°', 'error');
        }
        showCode('findResult', data);
      } catch (error) {
        showResult('findResult', `âŒ æŸ¥æ‰¾å¤±æ•—: ${error.message}`, 'error');
      }
    });

    // å®Œæ•´æµç¨‹æ¸¬è©¦
    document.getElementById('fullTestBtn').addEventListener('click', async () => {
      const results = [];
      let passed = 0;
      
      showResult('fullTestResult', 'ğŸš€ é–‹å§‹å®Œæ•´æµç¨‹æ¸¬è©¦...', 'info');
      
      const tests = [
        {
          name: 'APIå¥åº·æª¢æŸ¥',
          test: async () => {
            const res = await fetch(`${APPS_SCRIPT_ENDPOINT}?action=health`);
            const data = await res.json();
            return data.ok;
          }
        },
        {
          name: 'æª¢æŸ¥æœªç¶å®šç‹€æ…‹',
          test: async () => {
            // å…ˆç¢ºä¿è§£é™¤ç¶å®š
            await fetch(`${APPS_SCRIPT_ENDPOINT}?action=unbind_member_number&uid=test-user`);
            const res = await fetch(`${APPS_SCRIPT_ENDPOINT}?action=get_member_binding&uid=test-user`);
            const data = await res.json();
            return data.ok && !data.bound;
          }
        },
        {
          name: 'ç¶å®šæœƒå“¡è™Ÿç¢¼',
          test: async () => {
            const res = await fetch(`${APPS_SCRIPT_ENDPOINT}?action=bind_member_number&uid=test-user&member_number=1234`);
            const data = await res.json();
            return data.ok && data.member_number === '1234';
          }
        },
        {
          name: 'æª¢æŸ¥å·²ç¶å®šç‹€æ…‹',
          test: async () => {
            const res = await fetch(`${APPS_SCRIPT_ENDPOINT}?action=get_member_binding&uid=test-user`);
            const data = await res.json();
            return data.ok && data.bound && data.member_number === '1234';
          }
        },
        {
          name: 'æ¸¬è©¦é‡è¤‡ç¶å®š',
          test: async () => {
            const res = await fetch(`${APPS_SCRIPT_ENDPOINT}?action=bind_member_number&uid=another-user&member_number=1234`);
            const data = await res.json();
            return !data.ok && data.code === 'ALREADY_BOUND';
          }
        },
        {
          name: 'æŸ¥æ‰¾å·²ç¶å®šæœƒå“¡',
          test: async () => {
            const res = await fetch(`${APPS_SCRIPT_ENDPOINT}?action=find_member_by_number&member_number=1234`);
            const data = await res.json();
            return data.ok && data.found;
          }
        },
        {
          name: 'è§£é™¤ç¶å®š',
          test: async () => {
            const res = await fetch(`${APPS_SCRIPT_ENDPOINT}?action=unbind_member_number&uid=test-user`);
            const data = await res.json();
            return data.ok;
          }
        },
        {
          name: 'é©—è­‰è§£é™¤ç¶å®šå¾Œç‹€æ…‹',
          test: async () => {
            const res = await fetch(`${APPS_SCRIPT_ENDPOINT}?action=get_member_binding&uid=test-user`);
            const data = await res.json();
            return data.ok && !data.bound;
          }
        }
      ];
      
      for (const test of tests) {
        try {
          const result = await test.test();
          results.push({ name: test.name, passed: result });
          if (result) passed++;
        } catch (error) {
          results.push({ name: test.name, passed: false, error: error.message });
        }
      }
      
      const summary = `
ğŸ” å®Œæ•´æµç¨‹æ¸¬è©¦çµæœ:
  ç¸½æ¸¬è©¦æ•¸: ${tests.length}
  é€šéæ¸¬è©¦: ${passed}
  å¤±æ•—æ¸¬è©¦: ${tests.length - passed}
  æˆåŠŸç‡: ${Math.round((passed/tests.length) * 100)}%

${results.map(r => `  ${r.passed ? 'âœ…' : 'âŒ'} ${r.name}${r.error ? ` (${r.error})` : ''}`).join('\n')}

${passed === tests.length ? 'ğŸ‰ æ‰€æœ‰æ¸¬è©¦é€šéï¼æœƒå“¡è™Ÿç¢¼ç¶å®šåŠŸèƒ½æ­£å¸¸å·¥ä½œã€‚' : 'âš ï¸ éƒ¨åˆ†æ¸¬è©¦å¤±æ•—ï¼Œè«‹æª¢æŸ¥å¯¦ç¾ã€‚'}
      `;
      
      showResult('fullTestResult', summary, passed === tests.length ? 'success' : 'error');
    });

    // è‡ªå‹•é‹è¡Œå¥åº·æª¢æŸ¥
    setTimeout(() => {
      document.getElementById('healthBtn').click();
    }, 500);
  </script>
</body>
</html>