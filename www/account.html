<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>æœƒå“¡ä¸­å¿ƒ - CBON</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3EğŸ’³%3C/text%3E%3C/svg%3E">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    body { background:#0f1115; color:#fff; font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'PingFang HK','PingFang TC','Microsoft JhengHei','Noto Sans TC',sans-serif; }
    .container { max-width:720px; margin:0 auto; padding:20px 16px 80px; }
    .card { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); border-radius: 16px; padding: 20px; box-shadow: 0 8px 24px rgba(0,0,0,0.25); }
    .title { display:flex; align-items:center; gap:10px; font-size:1.2rem; font-weight:800; margin:0 0 6px; }
    .subtitle { color:#cbd5e1; margin:0 0 12px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .btn { display:inline-flex; align-items:center; gap:8px; height:40px; padding:0 14px; border-radius:10px; border:1px solid rgba(255,255,255,0.14); color:#fff; background:rgba(255,255,255,0.06); cursor:pointer; }
    .btn-primary { background: linear-gradient(135deg,#4285F4,#34A853); border:none; }
    .pill { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-weight:700; }
    .pill-green { background: rgba(16,185,129,0.12); color: #34d399; border: 1px solid rgba(16,185,129,0.25); }
    .muted { color:#94a3b8; }
    .list { margin-top:14px; }
    .item { display:flex; justify-content:space-between; align-items:center; padding:12px 10px; border-bottom:1px solid rgba(255,255,255,0.08); }
    .item .left { display:flex; flex-direction:column; gap:6px; }
    .item .title { font-size:1rem; font-weight:700; margin:0; }
    .item .desc { color:#cbd5e1; font-size:.9rem; }
    .item .points { font-weight:800; color:#ffb020; }
    .center { text-align:center; }
    .avatar { width:36px; height:36px; border-radius:50%; object-fit:cover; }
    .header { display:flex; align-items:center; gap:10px; margin-bottom:10px; }
    .member-number { font-family: 'Courier New', monospace; font-weight:800; color:#3b82f6; }
    .status-bound { color:#22c55e; }
    .status-unbound { color:#94a3b8; }
    .home-btn { background:rgba(34,197,94,0.2) !important; border-color:#22c55e !important; color:#22c55e !important; text-decoration:none; font-size:0.9rem; height:32px; padding:0 12px; transition: all 0.2s ease; }
    .home-btn:hover { background:rgba(34,197,94,0.3) !important; transform: translateY(-1px); }
    @media (max-width: 480px) {
      .home-btn span { display: none; }
      .home-btn { padding: 0 8px; min-width: 32px; justify-content: center; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="header">
        <a href="https://c----b.web.app/"><img src="images/cbon%20logo.jpeg" alt="CBON" style="width:28px;height:28px;border-radius:8px;object-fit:cover;"/></a>
        <div style="font-weight:800; flex:1;">æœƒå“¡ä¸­å¿ƒ</div>
        <a href="https://c----b.web.app/" class="btn home-btn" title="è¿”å›é¦–é ">
          <i class="fas fa-home"></i><span>è¿”å›é¦–é </span>
        </a>
      </div>

      <div id="authBox" class="row" style="margin-bottom:12px;">
        <img id="avatar" class="avatar" src="" alt="" style="display:none;"/>
        <div id="userInfo" class="muted" style="flex:1;">å°šæœªç™»å…¥</div>
        <button id="loginBtn" class="btn btn-primary"><i class="fab fa-google"></i><span>ä½¿ç”¨ Google ç™»å…¥</span></button>
        <button id="logoutBtn" class="btn" style="display:none;"><i class="fas fa-sign-out-alt"></i><span>ç™»å‡º</span></button>
      </div>
      
      <!-- ç§»å‹•ç«¯ç™»å…¥å•é¡Œæç¤º -->
      <div id="mobileLoginHelp" class="row" style="display:none; margin-bottom:16px; padding:12px; background:rgba(245,158,11,0.1); border:1px solid rgba(245,158,11,0.3); border-radius:10px;">
        <div style="flex:1; font-size:0.9rem;">
          <div style="color:#fbbf24; font-weight:600; margin-bottom:4px;"><i class="fas fa-mobile-alt"></i> æ‰‹æ©Ÿç™»å…¥é‡åˆ°å•é¡Œï¼Ÿ</div>
          <div style="color:#cbd5e1;">å¦‚æœç™»å…¥æŒ‰éˆ•ç„¡åæ‡‰ï¼Œå¯èƒ½æ˜¯å½ˆçª—è¢«é˜»æ­¢</div>
        </div>
        <a href="mobile-login-fix.html" class="btn" style="background:rgba(245,158,11,0.2); border-color:#fbbf24; color:#fbbf24; font-size:0.85rem; height:32px; padding:0 10px;">
          <i class="fas fa-wrench"></i><span>ä¿®å¾©åŠ©æ‰‹</span>
        </a>
      </div>

      <div class="pill pill-green" id="pointsPill" style="display:none;">
        <i class="fas fa-star"></i>
        <span>æˆ‘çš„ç´¯ç©ç©åˆ†ï¼š</span>
        <span id="totalPoints" style="font-weight:900;">0</span>
      </div>

      <!-- æœƒå“¡è™Ÿç¢¼ç¶å®šåŠŸèƒ½ -->
      <div id="memberBindingPanel" class="row" style="display:none; margin-top:16px; padding:16px; background:rgba(59,130,246,0.1); border:1px solid rgba(59,130,246,0.3); border-radius:12px;">
        <div style="flex:1;">
          <div style="font-weight:700; color:#3b82f6; margin-bottom:8px;"><i class="fas fa-id-card"></i> æœƒå“¡è™Ÿç¢¼ç¶å®š</div>
          <div id="bindingStatus" style="font-size:0.9rem; color:#cbd5e1; margin-bottom:12px;">æ‚¨å¯ä»¥ç¶å®šæ‚¨çš„4ä½æ•¸æœƒå“¡è™Ÿç¢¼</div>
          
          <div id="bindingForm" class="row" style="gap:8px; flex-wrap:wrap;">
            <input type="text" id="memberNumberInput" placeholder="è«‹è¼¸å…¥4ä½æ•¸æœƒå“¡è™Ÿç¢¼" 
                   style="flex:1; min-width:160px; height:36px; padding:0 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:rgba(255,255,255,0.06); color:#fff; font-size:14px;"
                   maxlength="4" pattern="[0-9]{1,4}">
            <button id="bindBtn" class="btn" style="background:rgba(59,130,246,0.2); border-color:#3b82f6; color:#3b82f6; height:36px; padding:0 12px;">
              <i class="fas fa-link"></i><span>ç¶å®š</span>
            </button>
          </div>
          
          <div id="unbindSection" style="display:none; margin-top:12px;">
            <button id="unbindBtn" class="btn" style="background:rgba(239,68,68,0.1); border-color:#ef4444; color:#ef4444; height:32px; padding:0 10px; font-size:0.85rem;">
              <i class="fas fa-unlink"></i><span>è§£é™¤ç¶å®š</span>
            </button>
          </div>
        </div>
      </div>

      <!-- ç®¡ç†å“¡åŠŸèƒ½å…¥å£ -->
      <div id="adminPanel" class="row" style="display:none; margin-top:16px; padding:12px; background:rgba(255,193,7,0.1); border:1px solid rgba(255,193,7,0.3); border-radius:10px;">
        <div style="flex:1;">
          <div style="font-weight:700; color:#ffc107;"><i class="fas fa-crown"></i> ç®¡ç†å“¡åŠŸèƒ½</div>
          <div style="font-size:0.9rem; color:#cbd5e1;">æœƒå“¡æ•´åˆèˆ‡ç³»çµ±ç®¡ç†</div>
        </div>
        <button id="adminBtn" class="btn" style="background:rgba(255,193,7,0.2); border-color:#ffc107; color:#ffc107;">
          <i class="fas fa-cog"></i><span>ç®¡ç†ä¸­å¿ƒ</span>
        </button>
      </div>

      <!-- æ–°å¢ï¼šå®¢æœèˆ‡ç¤¾ç¾¤ -->
      <div style="margin-top:16px;">
        <div style="font-weight:700; color:#cbd5e1; margin-bottom:8px;">
          <i class="fas fa-headset"></i> å®¢æœèˆ‡ç¤¾ç¾¤
        </div>
        <div class="row" style="gap:8px; flex-wrap:wrap;">
          <a href="https://chat.whatsapp.com/JiJ6SlwGVfrAl1YU6qonWC" class="btn" style="background:#25D366;border-color:#25D366;color:#0b1220;">
            <i class="fab fa-whatsapp"></i><span>WhatsApp å®¢æœ</span>
          </a>
          <a href="https://t.me/cbonshare?boost" class="btn" style="background:#0088cc;border-color:#0088cc;color:#0b1220;">
            <i class="fab fa-telegram-plane"></i><span>Telegram æ”¯æŒ</span>
          </a>
          <a href="/speedtest-records.html" class="btn" style="background:rgba(14,165,233,0.2);border-color:#0ea5e9;color:#0ea5e9;">
            <i class="fas fa-gauge"></i><span>æŸ¥çœ‹æœ€è¿‘æ¸¬é€Ÿç´€éŒ„</span>
          </a>
        </div>
      </div>

      <div class="list" id="historyList" style="display:none;">
        <!-- æ­·å²ç©åˆ†æ˜ç´° -->
      </div>

      <div id="emptyState" class="center muted" style="display:none;margin-top:16px;">å°šç„¡ç©åˆ†ç´€éŒ„</div>
    </div>
  </div>

  <script type="module">
    // åœ¨é–‹ç™¼æ¨¡å¼ä¸‹åŠ è¼‰æ¨¡æ“¬API
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      try {
        await import('./js/mock-api.js');
        console.log('ğŸš€ [é–‹ç™¼æ¨¡å¼] æ¨¡æ“¬APIå·²åŠ è¼‰');
      } catch (error) {
        console.warn('âš ï¸ [é–‹ç™¼æ¨¡å¼] æ¨¡æ“¬APIåŠ è¼‰å¤±æ•—:', error);
      }
    }

    import { auth, signInWithGoogle, signOutUser, waitForAuth, onAuthStateChanged } from './js/firebase-config.js?v=4';

    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const userInfo = document.getElementById('userInfo');
    const avatar = document.getElementById('avatar');
    const pointsPill = document.getElementById('pointsPill');
    const totalPointsEl = document.getElementById('totalPoints');
    const historyList = document.getElementById('historyList');
    const emptyState = document.getElementById('emptyState');

    const APPS_SCRIPT_ENDPOINT = localStorage.getItem('CBON_APPS_SCRIPT_URL') || 'https://script.google.com/macros/s/AKfycbwhdaWJHQV9sEbcNUP9bQmjjxYTk0HdNif_QKEqunp6fQfyufGiax14l2H36kpBssvyPQ/exec';

    // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
    function isMobileDevice() {
      const userAgent = navigator.userAgent || navigator.vendor || window.opera;
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent) ||
             (navigator.maxTouchPoints > 1 && /MacIntel/.test(navigator.platform));
    }

    // æ£€æµ‹ç§»åŠ¨ç«¯ç™»å½•é—®é¢˜å¹¶æ˜¾ç¤ºå¸®åŠ©æç¤º
    function checkMobileLoginIssues(user) {
      const helpPanel = document.getElementById('mobileLoginHelp');
      
      // å¦‚æœæ˜¯ç§»åŠ¨è®¾å¤‡ä¸”æœªç™»å½•ï¼Œæ˜¾ç¤ºå¸®åŠ©æç¤º
      if (isMobileDevice() && !user) {
        helpPanel.style.display = 'flex';
      } else {
        helpPanel.style.display = 'none';
      }
    }

    async function refreshUI() {
      console.log('æ­£åœ¨åˆ·æ–°UI...');
      const user = await waitForAuth();
      
      if (user) {
        console.log('ç”¨æˆ¶å·²ç™»å…¥:', user);
        userInfo.textContent = user.displayName || user.email || user.uid;
        if (user.photoURL) { avatar.src = user.photoURL; avatar.style.display = 'block'; }
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-flex';
        
        // æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™
        checkAdminAccess(user);
        
        // æª¢æŸ¥æœƒå“¡ç¶å®šç‹€æ…‹
        console.log('æ­£åœ¨æª¢æŸ¥æœƒå“¡ç¶å®šç‹€æ…‹...');
        checkMemberBinding(user.uid);
        
        fetchPoints(user.uid);
      } else {
        console.log('ç”¨æˆ¶æœªç™»å…¥');
        userInfo.textContent = 'å°šæœªç™»å…¥';
        avatar.style.display = 'none';
        loginBtn.style.display = 'inline-flex';
        logoutBtn.style.display = 'none';
        pointsPill.style.display = 'none';
        historyList.style.display = 'none';
        emptyState.style.display = 'block';
        document.getElementById('adminPanel').style.display = 'none';
        document.getElementById('memberBindingPanel').style.display = 'none';
      }
      
      // æ£€æŸ¥ç§»åŠ¨ç«¯ç™»å½•é—®é¢˜
      checkMobileLoginIssues(user);
    }

    async function fetchPoints(uid) {
      try {
        const url = `${APPS_SCRIPT_ENDPOINT}?action=get_points&uid=${encodeURIComponent(uid)}&origin=${encodeURIComponent(window.location.origin)}&_=${Date.now()}`;
        const res = await fetch(url, { method: 'GET', mode: 'cors', cache: 'no-cache' });
        const text = await res.text();
        let data = null; try { data = JSON.parse(text); } catch(_) { data = null; }
        if (!data || !data.ok) throw new Error(data?.error || 'æŸ¥è©¢å¤±æ•—');
        totalPointsEl.textContent = data.totalPoints || 0;
        pointsPill.style.display = 'inline-flex';
        renderHistory(data.history || []);
      } catch (e) {
        console.warn('Fetch points failed:', e);
        pointsPill.style.display = 'none';
        emptyState.style.display = 'block';
      }
    }

    function renderHistory(list) {
      historyList.innerHTML = '';
      if (!list.length) {
        historyList.style.display = 'none';
        emptyState.style.display = 'block';
        return;
      }
      emptyState.style.display = 'none';
      historyList.style.display = 'block';
      list.forEach(item => {
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
          <div class="left">
            <div class="title">å…¥å¸³ +${item.points} åˆ†</div>
            <div class="desc">Session ${item.session_id} Â· ${formatTime(item.awarded_at)}</div>
          </div>
          <div class="points">HK$${Math.round(item.amount/100) || 0}</div>
        `;
        historyList.appendChild(div);
      });
    }

    function formatTime(iso) {
      try { const d = new Date(iso); return d.toLocaleString(); } catch(_) { return iso; }
    }

    function checkAdminAccess(user) {
      // ç®¡ç†å“¡éƒµç®±åˆ—è¡¨ï¼ˆè«‹æ ¹æ“šå¯¦éš›æƒ…æ³ä¿®æ”¹ï¼‰
      const adminEmails = [
        'admin@cbon.shop',
        'cbonshare@gmail.com',  // è«‹æ›¿æ›ç‚ºå¯¦éš›ç®¡ç†å“¡éƒµç®±
        'demo@example.com'      // é–‹ç™¼æ¨¡å¼æ¨¡æ“¬ç”¨æˆ¶
      ];
      
      console.log('æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™:', {
        userEmail: user.email,
        userName: user.displayName,
        uid: user.uid,
        isDemo: user.isDemo,
        adminEmails: adminEmails
      });
      
      const isAdmin = adminEmails.includes(user.email);
      console.log('ç®¡ç†å“¡æ¬Šé™çµæœ:', isAdmin);
      
      document.getElementById('adminPanel').style.display = isAdmin ? 'flex' : 'none';
      
      if (isAdmin) {
        console.log('âœ… ç”¨æˆ¶å…·æœ‰ç®¡ç†å“¡æ¬Šé™');
      } else {
        console.log('âŒ ç”¨æˆ¶æ²’æœ‰ç®¡ç†å“¡æ¬Šé™ï¼Œå¦‚éœ€ç²å¾—æ¬Šé™è«‹è¯ç¹«ç®¡ç†å“¡');
      }
    }

    // æœƒå“¡è™Ÿç¢¼æ¨™æº–åŒ–å‡½æ•¸
    function normalizeMemberNumber(number) {
      if (!number) return null;
      const numStr = number.toString().replace(/\D/g, ''); // ç§»é™¤éæ•¸å­—å­—å…ƒ
      if (numStr.length === 0) return null;
      if (numStr.length <= 4) {
        return numStr.padStart(4, '0'); // å‰é¢è£œ0
      }
      return numStr.slice(-4); // å–æœ€å¾Œ4ä½
    }

    // æª¢æŸ¥æœƒå“¡ç¶å®šç‹€æ…‹
    async function checkMemberBinding(uid) {
      const panel = document.getElementById('memberBindingPanel');
      const status = document.getElementById('bindingStatus');
      const form = document.getElementById('bindingForm');
      const unbindSection = document.getElementById('unbindSection');
      
      // é¦–å…ˆé¡¯ç¤ºç¶å®šé¢æ¿
      panel.style.display = 'flex';
      
      try {
        const url = `${APPS_SCRIPT_ENDPOINT}?action=get_member_binding&uid=${encodeURIComponent(uid)}&origin=${encodeURIComponent(window.location.origin)}`;
        console.log('æª¢æŸ¥æœƒå“¡ç¶å®šç‹€æ…‹ API èª¿ç”¨:', url);
        
        const res = await fetch(url, { method: 'GET', mode: 'cors', cache: 'no-cache' });
        const data = await res.json();
        
        console.log('ç¶å®šç‹€æ…‹ API éŸ¿æ‡‰:', data);
        
        if (data.ok && data.bound) {
          // å·²ç¶å®šç‹€æ…‹
          status.innerHTML = `<span class="status-bound"><i class="fas fa-check-circle"></i> å·²ç¶å®šæœƒå“¡è™Ÿç¢¼ï¼š<span class="member-number">${data.member_number}</span></span>`;
          form.style.display = 'none';
          unbindSection.style.display = 'block';
        } else {
          // æœªç¶å®šç‹€æ…‹
          status.innerHTML = `<span class="status-unbound"><i class="fas fa-info-circle"></i> æ‚¨å¯ä»¥ç¶å®šæ‚¨çš„4ä½æ•¸æœƒå“¡è™Ÿç¢¼ï¼Œä»¥ä¾¿åŒæ­¥æ­·å²æ•¸æ“š</span>`;
          form.style.display = 'flex';
          unbindSection.style.display = 'none';
        }
      } catch (error) {
        console.error('æª¢æŸ¥ç¶å®šç‹€æ…‹å¤±æ•—:', error);
        // å³ä½¿APIå¤±æ•—ï¼Œä¹Ÿé¡¯ç¤ºç¶å®šç•Œé¢
        status.innerHTML = `<span class="status-unbound"><i class="fas fa-info-circle"></i> æ‚¨å¯ä»¥ç¶å®šæ‚¨çš„4ä½æ•¸æœƒå“¡è™Ÿç¢¼ï¼Œä»¥ä¾¿åŒæ­¥æ­·å²æ•¸æ“š</span>`;
        form.style.display = 'flex';
        unbindSection.style.display = 'none';
      }
    }

    // ç¶å®šæœƒå“¡è™Ÿç¢¼
    async function bindMemberNumber(uid, memberNumber) {
      try {
        const normalizedNumber = normalizeMemberNumber(memberNumber);
        if (!normalizedNumber) {
          throw new Error('è«‹è¼¸å…¥æœ‰æ•ˆçš„4ä½æ•¸æœƒå“¡è™Ÿç¢¼');
        }

        const url = `${APPS_SCRIPT_ENDPOINT}?action=bind_member_number&uid=${encodeURIComponent(uid)}&member_number=${normalizedNumber}&origin=${encodeURIComponent(window.location.origin)}`;
        const res = await fetch(url, { method: 'GET', mode: 'cors' });
        const data = await res.json();
        
        if (data.ok) {
          alert(`âœ… æˆåŠŸç¶å®šæœƒå“¡è™Ÿç¢¼ï¼š${normalizedNumber}`);
          checkMemberBinding(uid); // é‡æ–°æª¢æŸ¥ç‹€æ…‹
          document.getElementById('memberNumberInput').value = '';
        } else {
          if (data.code === 'ALREADY_BOUND') {
            const retry = confirm(`è©²æœƒå“¡è™Ÿç¢¼å·²è¢«å…¶ä»–ç”¨æˆ¶ç¶å®šã€‚\n\næ˜¯å¦å¼·åˆ¶ç¶å®šåˆ°æ‚¨çš„å¸³æˆ¶ï¼Ÿ\nï¼ˆé€™å°‡è§£é™¤è©²è™Ÿç¢¼èˆ‡å…¶ä»–ç”¨æˆ¶çš„ç¶å®šï¼‰`);
            if (retry) {
              return bindMemberNumberForce(uid, normalizedNumber);
            }
          } else if (data.code === 'USER_ALREADY_BOUND') {
            const retry = confirm(`æ‚¨å·²ç¶å®šæœƒå“¡è™Ÿç¢¼ï¼š${data.current_number}\n\næ˜¯å¦è¦æ›´æ›ç‚ºæ–°çš„æœƒå“¡è™Ÿç¢¼ï¼Ÿ`);
            if (retry) {
              return bindMemberNumberForce(uid, normalizedNumber);
            }
          } else {
            throw new Error(data.error || 'ç¶å®šå¤±æ•—');
          }
        }
      } catch (error) {
        console.error('ç¶å®šå¤±æ•—:', error);
        alert(`âŒ ç¶å®šå¤±æ•—ï¼š${error.message}`);
      }
    }

    // å¼·åˆ¶ç¶å®šæœƒå“¡è™Ÿç¢¼
    async function bindMemberNumberForce(uid, memberNumber) {
      try {
        const url = `${APPS_SCRIPT_ENDPOINT}?action=bind_member_number&uid=${encodeURIComponent(uid)}&member_number=${memberNumber}&force=true&origin=${encodeURIComponent(window.location.origin)}`;
        const res = await fetch(url, { method: 'GET', mode: 'cors' });
        const data = await res.json();
        
        if (data.ok) {
          alert(`âœ… æˆåŠŸç¶å®šæœƒå“¡è™Ÿç¢¼ï¼š${memberNumber}`);
          checkMemberBinding(uid);
          document.getElementById('memberNumberInput').value = '';
        } else {
          throw new Error(data.error || 'å¼·åˆ¶ç¶å®šå¤±æ•—');
        }
      } catch (error) {
        console.error('å¼·åˆ¶ç¶å®šå¤±æ•—:', error);
        alert(`âŒ å¼·åˆ¶ç¶å®šå¤±æ•—ï¼š${error.message}`);
      }
    }

    // è§£é™¤ç¶å®š
    async function unbindMemberNumber(uid) {
      if (!confirm('ç¢ºå®šè¦è§£é™¤æœƒå“¡è™Ÿç¢¼ç¶å®šå—ï¼Ÿ')) return;
      
      try {
        const url = `${APPS_SCRIPT_ENDPOINT}?action=unbind_member_number&uid=${encodeURIComponent(uid)}&origin=${encodeURIComponent(window.location.origin)}`;
        const res = await fetch(url, { method: 'GET', mode: 'cors' });
        const data = await res.json();
        
        if (data.ok) {
          alert('âœ… æˆåŠŸè§£é™¤æœƒå“¡è™Ÿç¢¼ç¶å®š');
          checkMemberBinding(uid);
        } else {
          throw new Error(data.error || 'è§£é™¤ç¶å®šå¤±æ•—');
        }
      } catch (error) {
        console.error('è§£é™¤ç¶å®šå¤±æ•—:', error);
        alert(`âŒ è§£é™¤ç¶å®šå¤±æ•—ï¼š${error.message}`);
      }
    }

    // é¡å¤–ï¼šiOS/Safari å¾å¤–éƒ¨è¿”å›æˆ–åˆ†é åˆ‡æ›å›å¯è¦‹æ™‚ï¼Œå¼·åˆ¶åˆ·æ–°ç‹€æ…‹
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') {
        console.log('visibilitychange -> visible, refreshing UI');
        refreshUI();
      }
    });

    // è‹¥åœ¨ iOS Safari ä¸Šï¼Œä¸»å‹•å°‡ç™»å…¥æµç¨‹è¨­ç‚º redirect å…œåº•ï¼ˆé¿å…ç„¡æç¤ºç›´æ¥è¿”å›ï¼‰
    function isIOSSafari() {
      const ua = navigator.userAgent;
      const isIOS = /iP(hone|od|ad)/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      const isSafari = /^((?!chrome|android).)*safari/i.test(ua);
      return isIOS && isSafari;
    }

    loginBtn.addEventListener('click', async () => {
      try {
        console.log('ç™»å…¥æŒ‰éˆ•è¢«é»æ“Š');

        // åœ¨ iOS Safari ä¸Šï¼Œç¢ºä¿ä¸€å®šèµ° redirect æµç¨‹ï¼ˆfirebase-config å…§å·²æœƒè‡ªå‹• fallbackï¼‰
        if (isIOSSafari()) {
          console.log('iOS Safari æª¢æ¸¬åˆ°ï¼Œå°‡ä½¿ç”¨é‡å®šå‘ç™»å…¥');
        }

        await signInWithGoogle();

        setTimeout(() => { refreshUI(); }, 200);
      } catch (e) {
        console.error('ç™»å…¥éŒ¯èª¤:', e);
        alert('ç™»å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦');
      }
    });
    logoutBtn.addEventListener('click', async () => {
      try { await signOutUser(); } catch(e) { alert('ç™»å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦'); }
    });
    
    // ç®¡ç†å“¡åŠŸèƒ½æŒ‰éˆ•
    document.getElementById('adminBtn').addEventListener('click', () => {
      window.location.href = 'member-integration.html';
    });

    // æœƒå“¡è™Ÿç¢¼ç¶å®šäº‹ä»¶
    document.getElementById('bindBtn').addEventListener('click', async () => {
      const user = await waitForAuth();
      if (!user) {
        alert('è«‹å…ˆç™»å…¥');
        return;
      }
      
      const memberNumber = document.getElementById('memberNumberInput').value.trim();
      if (!memberNumber) {
        alert('è«‹è¼¸å…¥4ä½æ•¸æœƒå“¡è™Ÿç¢¼');
        return;
      }
      
      await bindMemberNumber(user.uid, memberNumber);
    });

    // è§£é™¤ç¶å®šäº‹ä»¶
    document.getElementById('unbindBtn').addEventListener('click', async () => {
      const user = await waitForAuth();
      if (!user) {
        alert('è«‹å…ˆç™»å…¥');
        return;
      }
      
      await unbindMemberNumber(user.uid);
    });

    // è¼¸å…¥æ¡†äº‹ä»¶ - æŒ‰ Enter éµç¶å®š
    document.getElementById('memberNumberInput').addEventListener('keypress', async (e) => {
      if (e.key === 'Enter') {
        document.getElementById('bindBtn').click();
      }
    });

    // è¼¸å…¥æ¡†äº‹ä»¶ - åªå…è¨±æ•¸å­—è¼¸å…¥
    document.getElementById('memberNumberInput').addEventListener('input', (e) => {
      e.target.value = e.target.value.replace(/[^0-9]/g, '').slice(0, 4);
    });

    // iOS/Safariï¼šç›£è½ç™»å…¥ç‹€æ…‹è®ŠåŒ–ï¼ˆä¾‹å¦‚ Google Redirect å›ä¾†å¾Œï¼‰ï¼Œè‡ªå‹•åˆ·æ–° UI
    onAuthStateChanged(auth, () => {
      console.log('Auth state changed, refreshing UI');
      // è™•ç† iOS/Safari BFCacheï¼ˆè¿”å›æˆ–é‡è¼‰å¾Œç¢ºä¿ UI èˆ‡ç™»å…¥ç‹€æ…‹åŒæ­¥ï¼‰
      window.addEventListener('pageshow', (e) => {
        if (e.persisted) {
          console.log('pageshow from BFCache, refreshing UI');
        }
        refreshUI();
      });
    });

    refreshUI();
  </script>
  
  <!-- åº•éƒ¨å°èˆªï¼ˆèˆ‡å…¨ç«™ä¸€è‡´ï¼‰ -->
  <nav class="bottom-nav-mobile">
    <a href="https://cbon.shop.sn.cn/#/index" class="nav-btn eshop">
      <i class="fas fa-shopping-cart"></i>
      <span>EShop</span>
    </a>
    <a href="codes.html" class="nav-btn topup">
      <i class="fas fa-credit-card"></i>
      <span>Code</span>
    </a>
    <a href="ai-chat.html" class="nav-btn ai">
      <i class="fas fa-robot"></i>
      <span>AI</span>
    </a>
    <a href="/speedtest.html" class="nav-btn" style="background:#0ea5e9;color:#0b1220;">
      <i class="fas fa-gauge"></i>
      <span>Speed</span>
    </a>
    <a href="account.html" class="nav-btn account active">
      <i class="fas fa-user"></i>
      <span>æœƒå“¡</span>
    </a>
  </nav>
</body>
</html>