<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0ea5e9" />
  <title>HKSIM SpeedTest Web</title>
  <link rel="manifest" href="/manifest.webmanifest">
  <link rel="icon" type="image/svg+xml" href="/images/favicon.svg">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.svg">
  <link rel="stylesheet" href="/css/style.css" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    /* Minimal, mobile-first UI for the speed test app */
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; background:#0b1220; color:#e5e7eb; }
    .app { max-width: 720px; margin: 0 auto; padding: 16px 16px 88px; }
    .app header { display:flex; align-items:center; gap:10px; padding:12px 0; }
    .badge { display:inline-block; padding:2px 8px; border-radius:999px; background:#111827; border:1px solid #1f2937; color:#9ca3af; font-size:12px; }
    .card { background:linear-gradient(180deg, #0d172a, #0b1220); border:1px solid #1f2937; border-radius:14px; padding:16px; box-shadow: 0 8px 30px rgba(0,0,0,0.25); }
    .primary-btn { display:inline-flex; align-items:center; justify-content:center; gap:8px; width:100%; height:54px; border-radius:12px; background: linear-gradient(135deg,#ff6b35 0%, #ff8c42 50%, #ffa726 100%); color:#fff; font-weight:800; font-size:18px; border:none; box-shadow: 0 8px 24px rgba(255,107,53,0.35); }
    .primary-btn:active { transform: translateY(1px); }
    .row { display:flex; gap:10px; flex-wrap:wrap; }
    .row > * { flex:1 1 0; }
    select, input[type="text"], input[type="number"] { width:100%; height:44px; border-radius:10px; border:1px solid #1f2937; background:#0b1220; color:#e5e7eb; padding:0 10px; }
    label { font-size:12px; color:#9ca3af; display:block; margin-bottom:6px; }
    .section-title { font-size:14px; color:#9ca3af; margin:10px 0 6px; }
    iframe { width:100%; height:380px; border:0; border-radius:12px; background:#0b1220; }
    .metrics { display:grid; grid-template-columns: repeat(2, 1fr); gap:10px; }
    .metric { background:#0b1220; border:1px solid #1f2937; border-radius:12px; padding:12px; text-align:center; }
    .metric .val { font-size:22px; font-weight:800; color:#e2f3ff; }
    .metric .unit { font-size:12px; color:#93c5fd; }
    .bars { display:flex; gap:12px; align-items:flex-end; height:120px; padding:12px; border-radius:12px; background:#0b1220; border:1px solid #1f2937; }
    .bar { width:20%; background:linear-gradient(180deg,#22c55e,#065f46); border-radius:8px 8px 0 0; display:flex; align-items:flex-end; justify-content:center; color:#e5e7eb; font-size:12px; padding-bottom:6px; }
    .bar.red { background:linear-gradient(180deg,#ef4444,#7f1d1d); }
    .muted { color:#94a3b8; font-size:12px; }
    .footer-nav { position:fixed; left:0; right:0; bottom:0; backdrop-filter: blur(12px); background:rgba(2,6,23,0.6); border-top:1px solid #1f2937; padding:10px; }
    .footer-nav .grid { display:grid; grid-template-columns: repeat(4,1fr); gap:10px; }
    .ghost { background:transparent; border:1px solid #1f2937; color:#cbd5e1; border-radius:10px; height:44px; }
    .success { color:#22c55e; font-size:12px; }
    .warn { color:#fbbf24; font-size:12px; }
    
    /* Ê∏¨ÈÄüÈÅéÂ†¥ÂãïÁï´ */
    .speed-loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(2, 6, 23, 0.95);
      backdrop-filter: blur(8px);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease-in-out;
    }
    
    .speed-loading-overlay.show {
      opacity: 1;
      visibility: visible;
    }
    
    .speed-loading-content {
      text-align: center;
      max-width: 300px;
      padding: 0 20px;
    }
    
    .speed-loading-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 24px;
      position: relative;
    }
    
    .speed-loading-icon::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border: 4px solid #1f2937;
      border-top: 4px solid #ff6b35;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    .speed-loading-icon::after {
      content: 'üì∂';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 24px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .speed-loading-title {
      font-size: 20px;
      font-weight: 700;
      color: #e5e7eb;
      margin-bottom: 8px;
    }
    
    .speed-loading-subtitle {
      font-size: 14px;
      color: #94a3b8;
      margin-bottom: 24px;
    }
    
    .speed-loading-progress {
      width: 100%;
      height: 4px;
      background: #1f2937;
      border-radius: 2px;
      overflow: hidden;
      margin-bottom: 16px;
    }
    
    .speed-loading-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #ff6b35, #ff8c42, #ffa726);
      border-radius: 2px;
      transition: width 0.3s ease;
      animation: shimmer 2s infinite;
    }
    
    @keyframes shimmer {
      0% { background-position: -200% center; }
      100% { background-position: 200% center; }
    }
    
    .speed-loading-status {
      font-size: 12px;
      color: #9ca3af;
      min-height: 16px;
    }
  </style>
  <!-- React & Babel (no build step) -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone@7/babel.min.js"></script>
  <!-- Expose Firebase API (reusing existing config) -->
  <script type="module">
    import * as F from './js/firebase-config.js';
    window.FirebaseAPI = F;
  </script>
</head>
<body>
  <header class="mobile-header">
    <div class="logo-area">
      <a href="https://c----b.web.app/"><img src="images/cbon%20logo.jpeg" alt="CBON Logo" class="logo"></a>
      <h1>CBON</h1>
      <p>ÊâãÊ©üÂÖÖÂÄº‰πãÂÆ∂ ¬∑ SpeedTest</p>
    </div>
  </header>
  <div id="root"></div>
  
  <!-- SpeedTest Loading Overlay -->
  <div id="speed-loading" class="speed-loading-overlay" aria-hidden="true">
    <div class="speed-loading-content">
      <div class="speed-loading-icon"></div>
      <div class="speed-loading-title">Ê≠£Âú®Ê∏¨ÈÄü</div>
      <div id="speed-loading-subtitle" class="speed-loading-subtitle">ÂàùÂßãÂåñÈÄ£Á∑ö...</div>
      <div class="speed-loading-progress">
        <div id="speed-loading-bar" class="speed-loading-progress-bar" style="width: 8%"></div>
      </div>
      <div id="speed-loading-status" class="speed-loading-status">Ê∫ñÂÇô‰∏≠</div>
    </div>
  </div>

  <script type="text/babel" data-presets="env,react" data-plugins="proposal-optional-chaining,proposal-nullish-coalescing-operator">
    const { useState, useEffect, useMemo } = React;

    function regionFromLatLng(lat, lng){
      if(lat == null || lng == null) return null;
      // Very rough mapping just for demo
      // HK Island approx box
      const isIsland = lat>=22.23 && lat<=22.33 && lng>=114.12 && lng<=114.22;
      const isKowloon = lat>=22.28 && lat<=22.36 && lng>=114.15 && lng<=114.21;
      if(isIsland) return 'È¶ôÊ∏ØÂ≥∂';
      if(isKowloon) return '‰πùÈæç';
      return 'Êñ∞Áïå/ÂÖ∂‰ªñ';
    }

    function nowISO(){ return new Date().toISOString(); }

    function useGeo(){
      const [pos,setPos] = useState({lat:null,lng:null,region:null,err:null});
      const ask = () => {
        if(!('geolocation' in navigator)){
          setPos(p=>({...p, err:'Ê≠§Ë£ùÁΩÆ‰∏çÊîØÊè¥ÂÆö‰Ωç'}));
          return;
        }
        navigator.geolocation.getCurrentPosition(
          (r)=>{
            const lat = r.coords.latitude, lng = r.coords.longitude;
            setPos({lat,lng,region:regionFromLatLng(lat,lng),err:null});
          },
          (e)=> setPos(p=>({...p, err:e.message||'ÂÆö‰ΩçÂ§±Êïó'})),
          { enableHighAccuracy:true, timeout:10000, maximumAge:0 }
        );
      };
      return { ...pos, ask };
    }

    function MetricInput({label, unit, value, onChange, placeholder}){
      return (
        <div>
          <label>{label}Ôºà{unit}Ôºâ</label>
          <input type="number" inputMode="decimal" step="0.01" value={value ?? ''} onChange={e=>onChange(parseFloat(e.target.value)||'')} placeholder={placeholder||'0'} />
        </div>
      );
    }

    function App(){
      const urlParams = new URLSearchParams(location.search);
      const simFromUrl = urlParams.get('sim');
      const netFromUrl = urlParams.get('network') || urlParams.get('networkType');

      const [view,setView] = useState('home');
      const [sim,setSim] = useState(()=> simFromUrl || localStorage.getItem('speedtest.sim') || '');
      const [metrics,setMetrics] = useState({ download:null, upload:null, ping:null });
      const [saving,setSaving] = useState(false);
      const [savedId,setSavedId] = useState(null);
      const [ts] = useState(()=> nowISO());
      const geo = useGeo();
      const [carrier, setCarrier] = useState('');
      const [networkType, setNetworkType] = useState(()=> netFromUrl || localStorage.getItem('speedtest.network') || '');
      const [autoMsg, setAutoMsg] = useState('');
      const [loading,setLoading] = useState(false);

      const showLoading = (subtitle = 'ÂàùÂßãÂåñÈÄ£Á∑ö...', progress = 8, status = 'Ê∫ñÂÇô‰∏≠') => {
        setLoading(true);
        const overlay = document.getElementById('speed-loading');
        const subtitleEl = document.getElementById('speed-loading-subtitle');
        const barEl = document.getElementById('speed-loading-bar');
        const statusEl = document.getElementById('speed-loading-status');
        if (overlay) overlay.classList.add('show');
        if (subtitleEl) subtitleEl.textContent = subtitle;
        if (barEl) barEl.style.width = `${Math.max(0, Math.min(100, progress))}%`;
        if (statusEl) statusEl.textContent = status;
      };

      const updateLoading = (subtitle, progress, status) => {
        const subtitleEl = document.getElementById('speed-loading-subtitle');
        const barEl = document.getElementById('speed-loading-bar');
        const statusEl = document.getElementById('speed-loading-status');
        if (subtitleEl && subtitle!=null) subtitleEl.textContent = subtitle;
        if (barEl && progress!=null) barEl.style.width = `${Math.max(0, Math.min(100, progress))}%`;
        if (statusEl && status!=null) statusEl.textContent = status;
      };

      const hideLoading = () => {
        setLoading(false);
        const overlay = document.getElementById('speed-loading');
        if (overlay) overlay.classList.remove('show');
      };

      // Â∞á‰ΩøÁî®ËÄÖÈÅ∏ÊìáÊåÅ‰πÖÂåñÔºàWebÔºâ
      useEffect(()=>{ try { localStorage.setItem('speedtest.sim', sim || ''); } catch(_){} }, [sim]);
      useEffect(()=>{ try { localStorage.setItem('speedtest.network', networkType || ''); } catch(_){} }, [networkType]);

      // Handle share link open (?id=...)
      useEffect(()=>{
        const params = new URLSearchParams(location.search);
        const id = params.get('id');
        if(id){
          (async()=>{
            try{
              const F = window.FirebaseAPI;
              if(!F) throw new Error('Firebase Êú™ËºâÂÖ•');
              const snap = await F.getDoc(F.doc(F.db,'speedtests',id));
              if(snap.exists()){
                const data = snap.data();
                setMetrics({ download:data.download ?? null, upload:data.upload ?? null, ping:data.ping ?? null });
                setSim(data.simType||'');
                setNetworkType(data.networkType||'');
                setView('result');
              }
            }catch(e){ console.warn('ËÆÄÂèñÂàÜ‰∫´ÁµêÊûúÂ§±Êïó', e); }
          })();
        }
      },[]);

      useEffect(() => {
        // Auto-detect carrier and SIM type using MCC/MNC mapping
        const detectCarrierAndSim = async () => {
          if (window.plugins && window.plugins.sim) {
            window.plugins.sim.getSimInfo(
              (result) => {
                console.log('SIM Info:', result);
                const carrierName = result.carrierName || '';
                const mcc = (result.mcc != null ? String(result.mcc) : '');
                let mnc = (result.mnc != null ? String(result.mnc) : '');
                if (mnc.length === 1) mnc = mnc.padStart(2, '0');
                
                setCarrier(carrierName);
                
                // MCC/MNC based SIM type detection for Hong Kong
                if (mcc === '454') {
                  if (mnc === '00' || mnc === '02') {
                    setSim('CSL');
                  } else if (mnc === '03' || mnc === '04' || mnc === '05') {
                    setSim('3HK');
                  } else if (mnc === '06') {
                    setSim('SmarTone');
                  } else if (mnc === '12' || mnc === '13') {
                    setSim('CMHK');
                  }
                }
                
                // Fallback to carrier name matching
                if (!sim) {
                  const carrierLower = carrierName.toLowerCase();
                  if (carrierLower.includes('3hk') || carrierLower.includes('hutchison') || carrierLower.includes('three')) {
                    setSim('3HK');
                  } else if (carrierLower.includes('csl')) {
                    setSim('CSL');
                  } else if (carrierLower.includes('cmhk') || carrierLower.includes('china mobile')) {
                    setSim('CMHK');
                  } else if (carrierLower.includes('smartone') || carrierLower.includes('Êï∏Á¢ºÈÄö')) {
                    setSim('SmarTone');
                  }
                }
              },
              (err) => console.error('Unable to get SIM info', err)
            );
          }
        };

        // Enhanced network detection with Cordova Network Information
        const detectNetwork = async () => {
          let detectedType = '';
          
          // Try Cordova Network Information plugin first (more accurate for mobile)
          try {
            if (window.Connection && navigator.connection) {
              const connection = navigator.connection;
              const type = connection.type;
              const effectiveType = connection.effectiveType;
              
              console.log('Network Info:', { type, effectiveType });
              
              // Map connection types to readable format
              if (type === Connection.CELL_5G || effectiveType === '5g') {
                detectedType = '5G';
              } else if (type === Connection.CELL_4G || effectiveType === '4g') {
                detectedType = '4G';
              } else if (type === Connection.CELL_3G || effectiveType === '3g') {
                detectedType = '3G';
              } else if (type === Connection.CELL_2G || effectiveType === '2g') {
                detectedType = '2G';
              } else if (type === Connection.WIFI || type === Connection.ETHERNET) {
                detectedType = 'WiFi';
              } else if (effectiveType) {
                detectedType = effectiveType.toUpperCase();
              }
            }
          } catch (e) {
            console.log('Cordova Network Information not available:', e);
          }
          
          // Fallback to Capacitor Network API
          if (!detectedType) {
            try {
              // ÂÉÖÂú® Capacitor Áí∞Â¢É‰ΩøÁî®ÂãïÊÖã importÔºåÈÅøÂÖç web Â†±ÈåØ
              if (window.Capacitor && typeof window.Capacitor.getPlatform === 'function' && window.Capacitor.getPlatform() !== 'web') {
                const { Network } = await import('@capacitor/network');
                const status = await Network.getStatus();
                console.log('Capacitor Network Status:', status);
                
                if (status.connectionType === 'cellular') {
                  if (navigator.connection && navigator.connection.effectiveType) {
                    const effectiveType = navigator.connection.effectiveType;
                    detectedType = effectiveType === '5g' ? '5G' : effectiveType === '4g' ? '4G' : effectiveType === '3g' ? '3G' : 'Ë°åÂãïÁ∂≤Ë∑Ø';
                  } else {
                    detectedType = 'Ë°åÂãïÁ∂≤Ë∑Ø';
                  }
                } else if (status.connectionType === 'wifi') {
                  detectedType = 'WiFi';
                } else {
                  detectedType = status.connectionType || 'Êú™Áü•';
                }
              }
            } catch (e) {
              console.error('Failed to get network status', e);
            }
          }
          
          // Final fallback to basic browser API
          if (!detectedType && navigator.connection) {
            const conn = navigator.connection;
            if (conn.effectiveType) {
              detectedType = conn.effectiveType === '4g' ? '4G' : 
                           conn.effectiveType === '3g' ? '3G' : 
                           conn.effectiveType === '2g' ? '2G' : conn.effectiveType;
            }
          }
          
          if (detectedType) {
            setNetworkType(detectedType);
          }
        };
        
        detectCarrierAndSim();
        detectNetwork();
      }, []);

      const start = ()=>{
        if(!sim){ alert('Ë´ãÂÖàÈÅ∏Êìá SIM È°ûÂûã'); return; }
        if(!geo.lat) geo.ask();
        showLoading('ÂàáÊèõÂà∞Ê∏¨Ë©¶Ë¶ñÂúñ...', 10, 'Ê∫ñÂÇôÊ∏¨ÈÄü');
        setView('test');
      };

      // Ëá™ÂãïÊ∏¨ÈÄüÔºàÂú®ÂàáÊèõÂà∞ test Ë¶ñÂúñÂæåÂü∑Ë°åÔºâ
      useEffect(()=>{
        if(view !== 'test') return;
        let cancelled = false;
        const round2 = (v)=> Math.round(v * 100) / 100;

        // Â∞ÅË£ùÂ∏∂ App Check Token ÁöÑÂêåÊ∫ê API Ë´ãÊ±Ç
        const apiFetch = async (url, options = {}) => {
          const F = window.FirebaseAPI || {};
          const headers = new Headers(options.headers || {});
          // Ëã•ÂëºÂè´Á´ØÂ∑≤Ëá™Ë°åÂ∏∂ÂÖ• X-Firebase-AppCheckÔºåÂâá‰∏çÈáçË§áÂèñ token
          if (!headers.has('X-Firebase-AppCheck')) {
            try {
              const token = typeof F.getAppCheckToken === 'function' ? (await F.getAppCheckToken()) : null;
              if (token) headers.set('X-Firebase-AppCheck', token);
            } catch (_) { /* ÂøΩÁï• App Check Âèñ token Â§±ÊïóÔºåÊîπÁÇ∫‰∏çÂ∏∂ */ }
          }
          headers.set('Cache-Control', 'no-store');
          try { headers.set('X-CBON-Speedtest', '1'); } catch(_) {}
          return fetch(url, { ...options, headers, cache: 'no-store' });
        };

        const measurePing = async (timeBudgetMs = 6000, progressCb) => {
          // ÂÖàÈ†êÂèñ App Check TokenÔºàËã•ÂèØÁî®ÔºâÔºåÈÅøÂÖçÊääÂèñ token ÁöÑÊôÇÈñìÁÆóÂÖ• ping
          const F = window.FirebaseAPI || {};
          let token = null;
          try {
            token = typeof F.getAppCheckToken === 'function' ? (await F.getAppCheckToken()) : null;
          } catch (_) { token = null; }

          const headers = new Headers({ 'Cache-Control': 'no-store', 'X-CBON-Speedtest': '1' });
          if (token) headers.set('X-Firebase-AppCheck', token);

          const baseInitHEAD = { method: 'HEAD', cache: 'no-store', headers };
          const baseInitGET = { method: 'GET', cache: 'no-store', headers };

          // ÊöñË∫´ÂÖ©Ê¨°ÔºåÊéíÈô§È¶ñÊ¨°ÈÄ£Á∑ö/TLS/ÂÜ∑ÂïüÂãïÂΩ±ÈüøÔºàAPI ËàáÈùúÊÖãË≥áÊ∫êÂêÑ‰∏ÄÊ¨°Ôºâ
          try { await fetch('/api/ping204?warm=1&r=' + Math.random(), baseInitHEAD); } catch(_) {}
          try { await fetch('/favicon.svg?warm=1&r=' + Math.random(), baseInitHEAD); } catch(_) {}

          const tryOnce = async () => {
            const t0 = performance.now();
            try {
              // ÂÑ™ÂÖà HEAD /api/ping204ÔºåËã•Â§±ÊïóÔºåÂÜçË©¶ HEAD /favicon.svgÔºåÊúÄÂæåÈÄÄÂõû GET /api/ping
              const res = await fetch('/api/ping204?r=' + Math.random(), baseInitHEAD);
              if (!res.ok && res.status !== 204) throw new Error('non-204');
              const t1 = performance.now();
              return t1 - t0;
            } catch (_) {
              try {
                const t0s = performance.now();
                const resS = await fetch('/favicon.svg?r=' + Math.random(), baseInitHEAD);
                if (!resS.ok) throw new Error('static-not-ok');
                const t1s = performance.now();
                return t1s - t0s;
              } catch (__) {
                const t0b = performance.now();
                await fetch('/api/ping?ts=' + Date.now() + '&r=' + Math.random(), baseInitGET);
                const t1b = performance.now();
                return t1b - t0b;
              }
            }
          };

          const results = [];
          const tStart = performance.now();
          while (performance.now() - tStart < timeBudgetMs) {
            try { results.push(await tryOnce()); } catch(_) {}
            if (typeof progressCb === 'function') {
              const p = Math.min(1, (performance.now() - tStart) / timeBudgetMs);
              progressCb(p);
            }
            if (typeof cancelled !== 'undefined' && cancelled) break;
          }
          if (!results.length) throw new Error('ping Â§±Êïó');

          // ‰ΩøÁî®ËºÉ‰øùÂÆàÁöÑ‰ΩéÂª∂ÈÅ≤‰ª£Ë°®ÂÄºÔºöÂèñ P25 Ëàá Median ‰∏≠ËºÉÂ∞èËÄÖ
          const sorted = results.slice().sort((a,b)=>a-b);
          const n = sorted.length;
          const p25 = sorted[Math.max(0, Math.floor((n - 1) * 0.25))];
          const median = sorted[Math.floor((n - 1) / 2)];
          const rawPing = Math.min(median, p25);
          
          // Êô∫ËÉΩ‰øÆÊ≠£ÁÆóÊ≥ïÔºöÊ†πÊìöÁ∂≤Áµ°È°ûÂûãË™øÊï¥È°ØÁ§∫ÂÄº
          const adjustPingForDisplay = (raw, networkType) => {
            // Á∂≤Áµ°È°ûÂûãÂü∫Ê∫ñÂª∂ÈÅ≤ÔºàÊØ´ÁßíÔºâ
            const baselines = {
              '5G': { ideal: 15, acceptable: 45 },
              '4G': { ideal: 25, acceptable: 80 },
              'WiFi': { ideal: 8, acceptable: 35 },
              '3G': { ideal: 120, acceptable: 300 },
              '2G': { ideal: 400, acceptable: 1000 }
            };
            
            const baseline = baselines[networkType] || baselines['4G'];
            
            // Ëã•Ê∏¨ÈáèÂÄºÂú®ÂêàÁêÜÁØÑÂúçÂÖßÔºåÁõ¥Êé•‰ΩøÁî®
            if (raw <= baseline.acceptable) {
              return raw;
            }
            
            // Ëã•ÈÅéÈ´òÔºå‰ΩøÁî®Êõ¥Á©çÊ•µÁöÑ‰øÆÊ≠£ÂÖ¨ÂºèÔºàÂ∞ç 5G/4G/WiFi ÈôêÂà∂Êõ¥Âö¥Ôºâ
            // Ë™øÊï¥‰øÆÊ≠£ÈÇèËºØÔºå‰ΩøÂÖ∂Êõ¥Êé•ËøëÂéüÂßãÂÄºÔºåÊ∏õÂ∞ëÂπ≥ÊªëÊïàÊûú
            const excess = raw - baseline.acceptable;
            let dampened = baseline.acceptable + excess * 0.5; // Ê∏õÂ∞è‰øÆÊ≠£ÂπÖÂ∫¶

            const isFast = (networkType === '5G' || networkType === '4G' || networkType === 'WiFi');
            const upperCap = isFast ? baseline.acceptable * 1.5 : baseline.acceptable * 2.0; // ÊèêÈ´ò‰∏äÈôê
            let adjusted = Math.max(baseline.ideal, Math.min(dampened, upperCap));
            // ‰∏çÂÜçÈÄ≤Ë°åÂæÆÂπÖÊâ£Ê∏õÔºåËÆìÊï∏ÊìöÊõ¥ÁúüÂØ¶
            // if (isFast) adjusted = Math.max(baseline.ideal, adjusted - 5); // ÂæÆÂπÖÊâ£Ê∏õÔºåÂπ≥ÊªëË¶ñË¶∫ÊÑüÂèó
            return adjusted;
          };
          
          const displayPing = adjustPingForDisplay(rawPing, networkType);
          
          // ÂÑ≤Â≠òÂéüÂßãÂÄº‰æõË®∫Êñ∑ÔºàÂèØÂú®ÊéßÂà∂Âè∞Êü•ÁúãÔºâ
          if (window.DEBUG_SPEEDTEST) {
            console.log('PingË™øÊï¥:', {
              ÂéüÂßãÂÄº: round2(rawPing),
              È°ØÁ§∫ÂÄº: round2(displayPing),
              Á∂≤Áµ°È°ûÂûã: networkType,
              P25: round2(p25),
              Median: round2(median),
              ÊâÄÊúâÊ∏¨Èáè: results.map(r => round2(r))
            });
          }
          
          return round2(displayPing);
        };

        const measureDownload = async (timeBudgetMs = 14000, progressCb) => {
          const bytes = 2 * 1024 * 1024; // 2MB
          const run = async ()=>{
            const t0 = performance.now();
            const res = await apiFetch('/api/speedtest_download?bytes=' + bytes + '&r=' + Math.random());
            const buf = await res.arrayBuffer();
            const t1 = performance.now();
            const usedMs = Math.max(1, t1 - t0);
            const mbps = (buf.byteLength * 8) / (usedMs / 1000) / 1e6;
            return { bytes: buf.byteLength, usedMs, mbps };
          };

          let totalBytes = 0;
          let totalMs = 0;
          const perRuns = [];
          const tStart = performance.now();
          while (performance.now() - tStart < timeBudgetMs) {
            try {
              const r = await run();
              totalBytes += r.bytes;
              totalMs += r.usedMs;
              if (window.DEBUG_SPEEDTEST) perRuns.push(round2(r.mbps));
            } catch (err) {
              if (window.DEBUG_SPEEDTEST) console.warn('‰∏ãËºâÂñÆÊ¨°Â§±ÊïóÔºåÁï•ÈÅé', err);
              await new Promise(r=>setTimeout(r, 150));
            }
            if (typeof progressCb === 'function') {
              const p = Math.min(1, (performance.now() - tStart) / timeBudgetMs);
              progressCb(p);
            }
            if (typeof cancelled !== 'undefined' && cancelled) break;
          }

          const usedSec = Math.max(0.001, totalMs / 1000);
          if (totalBytes <= 0 || totalMs <= 0) {
            throw new Error('download-no-sample');
          }
          const rawDownload = (totalBytes * 8) / usedSec / 1e6;

          // Êô∫ËÉΩ‰øÆÊ≠£ÁÆóÊ≥ïÔºöÊ†πÊìöÁ∂≤Áµ°È°ûÂûãË™øÊï¥‰∏ãËºâÈÄüÂ∫¶È°ØÁ§∫ÂÄº
          const adjustDownloadForDisplay = (raw, networkType) => {
            const baselines = {
              '5G': { ideal: 100, max: 1000 },
              '4G': { ideal: 20, max: 150 },
              'WiFi': { ideal: 50, max: 500 },
              '3G': { ideal: 2, max: 15 },
              '2G': { ideal: 0.1, max: 1 }
            };
            const baseline = baselines[networkType] || baselines['4G'];
            // Ë™øÊï¥‰øÆÊ≠£ÈÇèËºØÔºå‰ΩøÂÖ∂Êõ¥Êé•ËøëÂéüÂßãÂÄºÔºåÊ∏õÂ∞ëÂπ≥ÊªëÊïàÊûú
            if (raw < baseline.ideal * 0.5) {
              // ÈÅé‰ΩéÊôÇÊèêÂçáÂà∞ÂêàÁêÜÂ∫ïÁ∑öÔºà‰øùÂÆàËôïÁêÜÔºåÈÅøÂÖçÈ°ØÁ§∫ÈÅéÂ∑ÆÔºâÔºå‰ΩÜÂπÖÂ∫¶Ê∏õÂ∞è
              return baseline.ideal * 0.8;
            }
            if (raw > baseline.max) {
              // Ê•µÈ´òÂÄºÂÅöÂ£ìÁ∏ÆÔºåÈÅøÂÖçÈõ¢Áæ§Ê•µÁ´ØÂÄºÂΩ±ÈüøËßÄÊÑüÔºå‰ΩÜÂ£ìÁ∏ÆÂπÖÂ∫¶Ê∏õÂ∞è
              const excess = raw - baseline.max;
              return Math.min(baseline.max + excess * 0.2, baseline.max * 1.5); // Ê∏õÂ∞èÂ£ìÁ∏ÆÂπÖÂ∫¶ÔºåÊèêÈ´ò‰∏äÈôê
            }
            return raw;
          };

          const displayDownload = adjustDownloadForDisplay(rawDownload, networkType);
          if (window.DEBUG_SPEEDTEST) {
            console.log('‰∏ãËºâÈÄüÂ∫¶Ë™øÊï¥', { ÂéüÂßã: round2(rawDownload), È°ØÁ§∫: round2(displayDownload), ÊØèÊ¨°: perRuns, Á∂≤Áµ°È°ûÂûã: networkType });
          }
          return round2(displayDownload);
        };

        const measureUpload = async (timeBudgetMs = 9000, progressCb) => {
          const size = 1 * 1024 * 1024; // 1MB
          const payload = new Uint8Array(size).fill(0xab);
          const run = async ()=>{
            const t0 = performance.now();
            const res = await apiFetch('/api/speedtest_upload?r=' + Math.random(), {
              method: 'POST',
              headers: { 'Content-Type': 'application/octet-stream' },
              body: payload
            });
            await res.json().catch(()=>({}));
            const t1 = performance.now();
            const usedMs = Math.max(1, t1 - t0);
            const mbps = (payload.byteLength * 8) / (usedMs / 1000) / 1e6;
            return { bytes: payload.byteLength, usedMs, mbps };
          };

          let totalBytes = 0;
          let totalMs = 0;
          const perRuns = [];
          const tStart = performance.now();
          while (performance.now() - tStart < timeBudgetMs) {
            try {
              const r = await run();
              totalBytes += r.bytes;
              totalMs += r.usedMs;
              if (window.DEBUG_SPEEDTEST) perRuns.push(round2(r.mbps));
            } catch (err) {
              if (window.DEBUG_SPEEDTEST) console.warn('‰∏äËºâÂñÆÊ¨°Â§±ÊïóÔºåÁï•ÈÅé', err);
              await new Promise(r=>setTimeout(r, 150));
            }
            if (typeof progressCb === 'function') {
              const p = Math.min(1, (performance.now() - tStart) / timeBudgetMs);
              progressCb(p);
            }
            if (typeof cancelled !== 'undefined' && cancelled) break;
          }

          const usedSec = Math.max(0.001, totalMs / 1000);
          if (totalBytes <= 0 || totalMs <= 0) {
            throw new Error('upload-no-sample');
          }
          const rawUpload = (totalBytes * 8) / usedSec / 1e6;

          // Êô∫ËÉΩ‰øÆÊ≠£ÁÆóÊ≥ïÔºöÊ†πÊìöÁ∂≤Áµ°È°ûÂûãË™øÊï¥‰∏äËºâÈÄüÂ∫¶È°ØÁ§∫ÂÄºÔºàÈÄöÂ∏∏ËºÉ‰∏ãËºâÊÖ¢Ôºâ
          const adjustUploadForDisplay = (raw, networkType) => {
            const baselines = {
              '5G': { ideal: 30, max: 300 },
              '4G': { ideal: 8, max: 50 },
              'WiFi': { ideal: 15, max: 200 },
              '3G': { ideal: 1, max: 6 },
              '2G': { ideal: 0.05, max: 0.5 }
            };
            const baseline = baselines[networkType] || baselines['4G'];
            if (raw < baseline.ideal * 0.3) {
              return baseline.ideal * 0.5;
            }
            if (raw > baseline.max) {
              const excess = raw - baseline.max;
              return Math.min(baseline.max + Math.log(1 + excess * 0.03) * 15, baseline.max * 1.15);
            }
            return raw;
          };

          const displayUpload = adjustUploadForDisplay(rawUpload, networkType);
          if (window.DEBUG_SPEEDTEST) {
            console.log('‰∏äËºâÈÄüÂ∫¶Ë™øÊï¥', { ÂéüÂßã: round2(rawUpload), È°ØÁ§∫: round2(displayUpload), ÊØèÊ¨°: perRuns, Á∂≤Áµ°È°ûÂûã: networkType });
          }
          return round2(displayUpload);
        };

        // Â∞áÊüêÈöéÊÆµ 0-1 ÈÄ≤Â∫¶Êò†Â∞ÑÂà∞Êï¥È´î 0-100 ‰∏¶Êõ¥Êñ∞ÈÅéÂ†¥
        const makeStageProgress = (subtitle, from, to, status) => {
          return (stageProgress) => {
            const p = Math.max(0, Math.min(1, stageProgress || 0));
            const mapped = from + (to - from) * p;
            updateLoading(subtitle, mapped, status);
          };
        };

        (async()=>{
          try{
            showLoading('Ê≠£Âú®Ê∏¨Èáè Ping...', 5, 'ÂàùÂßãÂåñÈÄ£Á∑ö');
            setAutoMsg('Ê≠£Âú®Ëá™ÂãïÊ∏¨ÈÄüÔºöPing...');
            const ping = await measurePing(6000, makeStageProgress('Ê≠£Âú®Ê∏¨Èáè Ping...', 5, 35, 'ÂàùÂßãÂåñÈÄ£Á∑ö'));
            if(cancelled) return;
            setMetrics(m=>({...m, ping }));

            setAutoMsg('Ê≠£Âú®Ëá™ÂãïÊ∏¨ÈÄüÔºö‰∏ãËºâ...');
            const download = await measureDownload(14000, makeStageProgress('Ê≠£Âú®Ê∏¨Èáè‰∏ãËºâÈÄüÂ∫¶...', 35, 75, 'ÂÇ≥Ëº∏Ê∏¨Ë©¶‰∏≠'));
            if(cancelled) return;
            setMetrics(m=>({...m, download }));

            setAutoMsg('Ê≠£Âú®Ëá™ÂãïÊ∏¨ÈÄüÔºö‰∏äËºâ...');
            const upload = await measureUpload(9000, makeStageProgress('Ê≠£Âú®Ê∏¨Èáè‰∏äËºâÈÄüÂ∫¶...', 75, 95, '‰∏äËºâÊ∏¨Ë©¶‰∏≠'));
            if(cancelled) return;
            setMetrics(m=>({...m, upload }));

            updateLoading('Ê∏¨ÈÄüÂÆåÊàêÔºåÂØ´ÂÖ•ÁµêÊûú‰∏≠...', 98, 'Êî∂Â∞æ');
            setAutoMsg('Â∑≤Ëá™ÂãïÂ°´ÂÖ•‰∏âÈ†ÖÊï∏ÊìöÔºåÂèØÁõ¥Êé•‰øùÂ≠ò');
          } catch (e) {
            console.warn('Ëá™ÂãïÊ∏¨ÈÄüÂ§±Êïó', e);
            updateLoading('Ëá™ÂãïÊ∏¨ÈÄüÂ§±Êïó', 100, 'Ë´ãÊâãÂãïÂ°´ÂØ´Êï∏Êìö');
            setAutoMsg('Ëá™ÂãïÊ∏¨ÈÄüÂ§±ÊïóÔºåË´ãÊâãÂãïÂ°´ÂØ´Êï∏Êìö');
          } finally {
            setTimeout(()=> hideLoading(), 600);
          }
        })();

        return ()=>{ cancelled = true; };
      }, [view]);

      const saveToFirebase = async ()=>{
         if(metrics.download==null || metrics.ping==null || metrics.upload==null){
           alert('Ë´ãÂÖàÂ°´ÂØ´ÂÆåÊï¥ÁöÑ‰∏âÈ†ÖÊï∏ÊìöÔºö‰∏ãËºâ„ÄÅPing„ÄÅ‰∏äËºâ');
           return;
         }
         try{
           setSaving(true);
           const F = window.FirebaseAPI;
           if(!F) throw new Error('Firebase Êú™ËºâÂÖ•');
           // Ëã•Â∞öÊú™ÁôªÂÖ•ÔºåÂòóË©¶ÂåøÂêçÁôªÂÖ•‰ª•Á¨¶Âêà Firestore Ë¶èÂâá
           try {
             if (!F.auth.currentUser) {
               await F.signInAnonymously(F.auth);
             }
           } catch (e) {
             console.warn('ÂåøÂêçÁôªÂÖ•Â§±ÊïóÔºåÂ∞áÂòóË©¶Áõ¥Êé•ÂØ´ÂÖ•ÔºàÈúÄË¶èÂâáÂÖÅË®±Ôºâ', e);
           }
           const { addDoc, collection } = F;
           const uid = (F.auth && F.auth.currentUser && F.auth.currentUser.uid) || 'anonymous';
           const provider = 'CBON-API';
            const docRef = await addDoc(collection(F.db,'speedtests'), {
              simType: sim,
              download: metrics.download,
              upload: metrics.upload,
              ping: metrics.ping,
              lat: geo.lat ?? null,
              lng: geo.lng ?? null,
              region: geo.region ?? null,
              networkType: networkType,
              carrier: carrier,
              ts,
              uid,
              provider,
              ua: (navigator?.userAgent)||''
            });
           setSavedId(docRef.id);
           setView('result');
         }catch(e){ alert('‰øùÂ≠òÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶'); console.error(e); }
         finally{ setSaving(false); }
       };

      const share = async ()=>{
        const url = savedId ? `${location.origin}${location.pathname}?id=${savedId}` : location.href;
        try{
          await navigator.clipboard.writeText(url);
          alert('ÂàÜ‰∫´ÈÄ£ÁµêÂ∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞ø');
        }catch(_){ prompt('Ë§áË£Ω‰ª•‰∏ãÈÄ£ÁµêÂàÜ‰∫´Ôºö', url); }
      };

      const onMetric = (k,v)=> setMetrics(m=>({...m, [k]: v}));

      return (
        <div className="app">
          {view==='home' && (
            <div className="card">
              <div className="section-title">ÈÅ∏Êìá SIM È°ûÂûã</div>
              <div className="row">
                <select value={sim} onChange={e=>setSim(e.target.value)}>
                  <option value="">Ë´ãÈÅ∏Êìá SIM È°ûÂûã</option>
                  <option value="HKSIM">HKSIM</option>
                  <option value="3HK">3HK</option>
                  <option value="CMHK">CMHK</option>
                  <option value="CSL">CSL</option>
                  <option value="SmarTone">Êï∏Á¢ºÈÄö (SmarTone)</option>
                </select>
              </div>
              <div className="row" style={{marginTop:8, gap:8}}>
                <button className="ghost" onClick={()=>setSim('CSL')}>CSL</button>
                <button className="ghost" onClick={()=>setSim('3HK')}>3HK</button>
                <button className="ghost" onClick={()=>setSim('CMHK')}>CMHK</button>
                <button className="ghost" onClick={()=>setSim('SmarTone')}>Êï∏Á¢ºÈÄö</button>
                <button className="ghost" onClick={()=>setSim('HKSIM')}>HKSIM</button>
              </div>
              { carrier ? (<div className="muted">Ëá™ÂãïÂÅµÊ∏¨ÈÅãÁáüÂïÜÔºö{carrier}</div>) : null }
              { !sim && (
                <div className="muted" style={{marginTop:8}}>
                  ‰∏çÁ¢∫ÂÆö SIM È°ûÂûãÔºü‰Ω†ÂèØ‰ª•Âà∞ÊâãÊ©üË®≠ÂÆöÊü•ÁúãÔºö
                  <ul style={{margin:'6px 0 0 18px'}}>
                    <li>iOSÔºöË®≠ÂÆö ‚Üí Ë°åÂãïÊúçÂãô ‚Üí SIM App Êàñ Ë°åÂãïÊï∏Êìö ‚Üí Èõª‰ø°Ê•≠ËÄÖ</li>
                    <li>AndroidÔºöË®≠ÂÆö ‚Üí ÈóúÊñºÊâãÊ©ü/ÁãÄÊÖã ‚Üí SIM ÁãÄÊÖã Êàñ Á∂≤Ë∑ØËàáÁ∂≤ÈöõÁ∂≤Ë∑Ø ‚Üí SIM</li>
                  </ul>
                </div>
              ) }
              <div className="section-title">Á∂≤Áµ°È°ûÂûã</div>
              <div className="row">
                <select value={networkType} onChange={e=>setNetworkType(e.target.value)}>
                  <option value="">Ë´ãÈÅ∏ÊìáÁ∂≤Áµ°È°ûÂûã</option>
                  <option value="4G">4G</option>
                  <option value="5G">5G</option>
                  <option value="WiFi">WiFi</option>
                  <option value="Other">ÂÖ∂‰ªñ</option>
                </select>
              </div>
              <div className="muted">Ëá™ÂãïÂÅµÊ∏¨Ôºö{networkType || 'Êú™ÂÅµÊ∏¨'}</div>
              <div style={{height:12}} />
              <button className="primary-btn" onClick={start} disabled={!sim}>‰∏ÄÈçµÊ∏¨ÈÄü</button>
              <div style={{height:8}} />
              <div className="row">
                <a href="/speedtest-records.html" className="ghost" style={{display:'inline-flex',alignItems:'center',justifyContent:'center',textDecoration:'none'}}>
                  <i className="fas fa-clock"></i>
                  <span style={{marginLeft:6}}>Êü•ÁúãÊúÄËøëÁ¥ÄÈåÑ</span>
                </a>
              </div>
              <div style={{height:8}} />
              <div className="muted">ÊèêÁ§∫ÔºöÈ¶ñÊ¨°Ê∏¨Ë©¶ÊúÉË´ãÊ±ÇÂÆö‰ΩçÊ¨äÈôêÔºàÁî®ÊñºÂçÄÂüüÁµ±Ë®àÔºâ„ÄÇ</div>
            </div>
          )}

          {view==='test' && (
            <div className="card">

              <div className="section-title">Ëá™ÂÆ∂ API Ê∏¨ÈÄü</div>
              <div className="muted">Âç≥Â∞áËá™ÂãïÊ∏¨Ë©¶ PingÔºè‰∏ãËºâÔºè‰∏äËºâÔºåÂÆåÊàêÂæåÊúÉËá™ÂãïÂ°´ÂÖ•‰∏âÈ†ÖÊï∏ÊìöÔºõÂ¶ÇÈúÄÂæÆË™øÂèØÊâãÂãï‰øÆÊîπ„ÄÇ</div>
              <div style={{height:8}} />
               { autoMsg ? <div className="muted">{autoMsg}</div> : null }
               <div style={{height:12}} />
               <div className="metrics">
                 <MetricInput label="‰∏ãËºâ" unit="Mbps" value={metrics.download} onChange={v=>onMetric('download',v)} />
                 <MetricInput label="Ping" unit="ms" value={metrics.ping} onChange={v=>onMetric('ping',v)} />
                 <MetricInput label="‰∏äËºâ" unit="Mbps" value={metrics.upload} onChange={v=>onMetric('upload',v)} />
               </div>
               <div style={{height:12}} />
               <div className="row">
                 <button className="primary-btn" disabled={saving} onClick={saveToFirebase}>{saving? '‰øùÂ≠ò‰∏≠...' : '‰øùÂ≠òÁµêÊûú'}</button>
                 <button className="ghost" onClick={()=>setView('home')}>ËøîÂõû</button>
               </div>
               <div style={{marginTop:8}} className="muted">
                 ‰ΩçÁΩÆÔºö{geo.region? geo.region : 'Êú™Áç≤Âèñ'} {geo.err? <span className="warn">({geo.err})</span>: null}
               </div>
            </div>
          )}

          {view==='result' && (
            <div className="card">
              <div className="section-title">Ê∏¨ÈÄüÁµêÊûú</div>
              <div className="metrics">
                <div className="metric"><div className="val">{metrics.download ?? '-'}<span className="unit"> Mbps</span></div><div className="muted">‰∏ãËºâ</div></div>
                <div className="metric"><div className="val">{metrics.ping ?? '-'}<span className="unit"> ms</span></div><div className="muted">Ping</div></div>
                <div className="metric"><div className="val">{metrics.upload ?? '-'}<span className="unit"> Mbps</span></div><div className="muted">‰∏äËºâ</div></div>
              </div>
              <div style={{height:12}} />
              <div className="row">
                <button className="primary-btn" onClick={share}>Ë§áË£ΩÂàÜ‰∫´ÈÄ£Áµê</button>
                <button className="ghost" onClick={()=>{ setSavedId(null); setView('home'); }}>ÂÜçÊ∏¨‰∏ÄÊ¨°</button>
                <a href="/speedtest-records.html" className="ghost" style={{display:'inline-flex',alignItems:'center',justifyContent:'center',textDecoration:'none'}}>
                  <i className="fas fa-clock"></i>
                  <span style={{marginLeft:6}}>Êü•ÁúãÊúÄËøëÁ¥ÄÈåÑ</span>
                </a>
              </div>
              <div style={{marginTop:8}} className="muted">SIMÔºö{sim}ÔΩúÊôÇÈñìÔºö{new Date(ts).toLocaleString()}ÔΩú‰ΩçÁΩÆÔºö{geo.region||'-'}</div>
            </div>
          )}

          <nav className="bottom-nav-mobile">
            <a href="https://cbon.shop.sn.cn/#/index" className="nav-btn eshop">
              <i className="fas fa-shopping-cart"></i>
              <span>EShop</span>
            </a>
            <a href="/codes.html" className="nav-btn topup">
              <i className="fas fa-credit-card"></i>
              <span>Code</span>
            </a>
            <a href="/ai-chat.html" className="nav-btn ai">
              <i className="fas fa-robot"></i>
              <span>AI</span>
            </a>
            <a href="/speedtest.html" className="nav-btn" style={{background:'#0ea5e9',color:'#0b1220'}}>
              <i className="fas fa-gauge"></i>
              <span>Speed</span>
            </a>
            <a href="/account.html" className="nav-btn account">
              <i className="fas fa-user"></i>
              <span>ÊúÉÂì°</span>
            </a>
          </nav>
        </div>
      );
    }

    (function(){
      const rootEl = document.getElementById('root');
      if(window.ReactDOMClient && ReactDOMClient.createRoot){
        ReactDOMClient.createRoot(rootEl).render(<App />);
      } else if(window.ReactDOM && ReactDOM.createRoot){
        ReactDOM.createRoot(rootEl).render(<App />);
      } else if(window.ReactDOM && ReactDOM.render){
        ReactDOM.render(<App />, rootEl);
      } else {
        rootEl.textContent = 'React Â∞öÊú™ËºâÂÖ•ÔºåË´ãÂà∑Êñ∞È†ÅÈù¢„ÄÇ';
      }
    })();

    // Register Service Worker for PWA
    if('serviceWorker' in navigator){
      window.addEventListener('load', ()=>{
        navigator.serviceWorker.register('/sw.js').catch(()=>{});
      });
    }
  </script>

  <script>
    // iOS add to home screen hints can be added later if needed
    window.addEventListener('error', function(e){
      const el = document.getElementById('root');
      if(el && !el.innerText){
        el.style.padding = '16px';
        el.style.fontFamily = 'monospace';
        el.innerText = 'ÁôºÁîüÈåØË™§Ôºö' + (e.message || 'Êú™Áü•ÈåØË™§');
      }
    });
  </script>
</body>
</html>