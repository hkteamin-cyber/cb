<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æœƒå“¡æ•´åˆç®¡ç† - CBON</title>
  <link rel="stylesheet" href="css/style.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    body { background:#0f1115; color:#fff; font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'PingFang HK','PingFang TC','Microsoft JhengHei','Noto Sans TC',sans-serif; }
    .container { max-width:1200px; margin:0 auto; padding:20px 16px 80px; }
    .card { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); border-radius: 16px; padding: 20px; box-shadow: 0 8px 24px rgba(0,0,0,0.25); margin-bottom: 20px; }
    .title { font-size:1.4rem; font-weight:800; margin:0 0 16px; color:#4285F4; }
    .subtitle { color:#cbd5e1; margin:0 0 12px; font-size:0.9rem; }
    .form-group { margin-bottom: 16px; }
    .form-label { display: block; margin-bottom: 6px; font-weight: 600; color: #e2e8f0; }
    .form-input { width: 100%; padding: 12px; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.05); color: #fff; font-size: 14px; }
    .form-input:focus { outline: none; border-color: #4285F4; }
    .btn { display: inline-flex; align-items: center; gap: 8px; padding: 12px 20px; border-radius: 10px; border: none; cursor: pointer; font-weight: 600; text-decoration: none; transition: all 0.2s; }
    .btn-primary { background: linear-gradient(135deg,#4285F4,#34A853); color: white; }
    .btn-secondary { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); }
    .btn-danger { background: linear-gradient(135deg,#dc2626,#b91c1c); color: white; }
    .btn:hover { transform: translateY(-1px); }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
    .status-badge { display: inline-block; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600; }
    .status-success { background: rgba(34,197,94,0.2); color: #22c55e; }
    .status-warning { background: rgba(251,191,36,0.2); color: #fbbf24; }
    .status-error { background: rgba(239,68,68,0.2); color: #ef4444; }
    .progress-bar { width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; margin: 10px 0; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #4285F4, #34A853); transition: width 0.3s; }
    .log-item { padding: 10px; border-left: 3px solid #4285F4; margin: 8px 0; background: rgba(255,255,255,0.03); border-radius: 4px; }
    .log-time { color: #94a3b8; font-size: 12px; }
    .table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    .table th, .table td { padding: 12px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .table th { background: rgba(255,255,255,0.05); font-weight: 600; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <!-- é ­éƒ¨ -->
    <div class="card">
      <div class="title">
        <i class="fas fa-users-cog"></i>
        æœƒå“¡æ•´åˆç®¡ç†ç³»çµ±
      </div>
      <p class="subtitle">æ•´åˆå¤šå€‹ç¶²ç«™çš„æœƒå“¡è¨˜éŒ„åˆ° CBON çµ±ä¸€å¹³å°</p>
    </div>

    <!-- ç¶²ç«™é…ç½® -->
    <div class="grid">
      <div class="card">
        <h3><i class="fas fa-cog"></i> ç¶²ç«™é…ç½®</h3>
        <div class="form-group">
          <label class="form-label">ç¶²ç«™ 1 åç¨±</label>
          <input type="text" class="form-input" id="site1Name" placeholder="ä¾‹å¦‚ï¼šèˆŠç‰ˆå•†åŸ">
        </div>
        <div class="form-group">
          <label class="form-label">è³‡æ–™åº«é€£æ¥å­—ä¸²</label>
          <input type="text" class="form-input" id="site1Db" placeholder="è³‡æ–™åº«URLæˆ–APIç«¯é»">
        </div>
        <div class="form-group">
          <label class="form-label">API å¯†é‘°</label>
          <input type="password" class="form-input" id="site1Key" placeholder="èªè­‰å¯†é‘°">
        </div>
        <span class="status-badge status-warning" id="site1Status">æœªé…ç½®</span>
      </div>

      <div class="card">
        <h3><i class="fas fa-cog"></i> ç¶²ç«™é…ç½®</h3>
        <div class="form-group">
          <label class="form-label">ç¶²ç«™ 2 åç¨±</label>
          <input type="text" class="form-input" id="site2Name" placeholder="ä¾‹å¦‚ï¼šEShop">
        </div>
        <div class="form-group">
          <label class="form-label">è³‡æ–™åº«é€£æ¥å­—ä¸²</label>
          <input type="text" class="form-input" id="site2Db" placeholder="è³‡æ–™åº«URLæˆ–APIç«¯é»">
        </div>
        <div class="form-group">
          <label class="form-label">API å¯†é‘°</label>
          <input type="password" class="form-input" id="site2Key" placeholder="èªè­‰å¯†é‘°">
        </div>
        <span class="status-badge status-warning" id="site2Status">æœªé…ç½®</span>
      </div>

      <div class="card">
        <h3><i class="fas fa-cog"></i> ç¶²ç«™é…ç½®</h3>
        <div class="form-group">
          <label class="form-label">ç¶²ç«™ 3 åç¨±</label>
          <input type="text" class="form-input" id="site3Name" placeholder="ä¾‹å¦‚ï¼šWhatsAppå•†åŸ">
        </div>
        <div class="form-group">
          <label class="form-label">è³‡æ–™åº«é€£æ¥å­—ä¸²</label>
          <input type="text" class="form-input" id="site3Db" placeholder="è³‡æ–™åº«URLæˆ–APIç«¯é»">
        </div>
        <div class="form-group">
          <label class="form-label">API å¯†é‘°</label>
          <input type="password" class="form-input" id="site3Key" placeholder="èªè­‰å¯†é‘°">
        </div>
        <span class="status-badge status-warning" id="site3Status">æœªé…ç½®</span>
      </div>
    </div>

    <!-- æ•´åˆæ“ä½œ -->
    <div class="card">
      <h3><i class="fas fa-sync-alt"></i> æœƒå“¡æ•¸æ“šæ•´åˆ</h3>
      <div class="grid">
        <div>
          <h4>æ•¸æ“šåŒæ­¥é¸é …</h4>
          <div style="margin: 10px 0;">
            <label><input type="checkbox" id="syncUsers" checked> åŒæ­¥ç”¨æˆ¶åŸºæœ¬è³‡æ–™</label>
          </div>
          <div style="margin: 10px 0;">
            <label><input type="checkbox" id="syncOrders" checked> åŒæ­¥è¨‚å–®è¨˜éŒ„</label>
          </div>
          <div style="margin: 10px 0;">
            <label><input type="checkbox" id="syncPoints" checked> åŒæ­¥ç©åˆ†è¨˜éŒ„</label>
          </div>
          <div style="margin: 10px 0;">
            <label><input type="checkbox" id="mergeAccounts"> è‡ªå‹•åˆä½µé‡è¤‡å¸³æˆ¶</label>
          </div>
          <div style="margin: 10px 0;">
            <label><input type="checkbox" id="handleMemberNumbers"> è™•ç†4ä½æ•¸æœƒå“¡è™Ÿç¢¼</label>
          </div>
        </div>
        <div>
          <h4>åŒæ­¥é€²åº¦</h4>
          <div class="progress-bar">
            <div class="progress-fill" id="syncProgress" style="width: 0%;"></div>
          </div>
          <p id="syncStatus">æº–å‚™å°±ç·’</p>
          <div style="margin-top: 16px;">
            <button class="btn btn-primary" id="startSync">
              <i class="fas fa-play"></i> é–‹å§‹åŒæ­¥
            </button>
            <button class="btn btn-secondary" id="testConnection">
              <i class="fas fa-plug"></i> æ¸¬è©¦é€£æ¥
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- åŒæ­¥æ—¥èªŒ -->
    <div class="card">
      <h3><i class="fas fa-list"></i> åŒæ­¥æ—¥èªŒ</h3>
      <div id="syncLogs">
        <div class="log-item">
          <div class="log-time">2024-01-20 14:30:00</div>
          <div>ç³»çµ±åˆå§‹åŒ–å®Œæˆ</div>
        </div>
      </div>
    </div>

    <!-- æœƒå“¡çµ±è¨ˆ -->
    <div class="card">
      <h3><i class="fas fa-chart-bar"></i> æœƒå“¡çµ±è¨ˆ</h3>
      <table class="table">
        <thead>
          <tr>
            <th>ä¾†æºç¶²ç«™</th>
            <th>æœƒå“¡æ•¸é‡</th>
            <th>è¨‚å–®ç¸½æ•¸</th>
            <th>ç©åˆ†ç¸½é¡</th>
            <th>æœ€å¾ŒåŒæ­¥</th>
            <th>ç‹€æ…‹</th>
          </tr>
        </thead>
        <tbody id="statsTable">
          <tr>
            <td>CBON æœ¬ç«™</td>
            <td id="localUsers">0</td>
            <td id="localOrders">0</td>
            <td id="localPoints">0</td>
            <td>å³æ™‚</td>
            <td><span class="status-badge status-success">æ­£å¸¸</span></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script type="module">
    import { auth, waitForAuth } from './js/firebase-config.js';

    class MemberIntegration {
      constructor() {
        this.isAdmin = false;
        this.syncInProgress = false;
        this.init();
      }

      async init() {
        await this.checkAdminAccess();
        this.bindEvents();
        this.loadConfiguration();
        this.loadStatistics();
      }

      async checkAdminAccess() {
        const user = await waitForAuth();
        if (!user) {
          alert('è«‹å…ˆç™»å…¥');
          window.location.href = 'account.html';
          return;
        }

        console.log('æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™:', {
          userEmail: user.email,
          userName: user.displayName,
          uid: user.uid,
          isDemo: user.isDemo
        });

        // æª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡ï¼ˆé€™è£¡å¯ä»¥è¨­å®šç®¡ç†å“¡éƒµç®±åˆ—è¡¨ï¼‰
        const adminEmails = [
          'admin@cbon.shop',
          'cbonshare@gmail.com',  // è«‹æ›¿æ›ç‚ºå¯¦éš›ç®¡ç†å“¡éƒµç®±
          'demo@example.com'      // é–‹ç™¼æ¨¡å¼æ¨¡æ“¬ç”¨æˆ¶
        ];
        
        this.isAdmin = adminEmails.includes(user.email);
        console.log('ç®¡ç†å“¡æ¬Šé™çµæœ:', this.isAdmin);
        
        if (!this.isAdmin) {
          alert(`æ‚¨æ²’æœ‰ç®¡ç†å“¡æ¬Šé™\n\nç•¶å‰ç”¨æˆ¶: ${user.email}\nç®¡ç†å“¡åˆ—è¡¨: ${adminEmails.join(', ')}\n\nè«‹è¯ç¹«ç®¡ç†å“¡æ–°å¢æ‚¨çš„éƒµç®±åˆ°ç®¡ç†å“¡åˆ—è¡¨ä¸­`);
          window.location.href = 'index.html';
        } else {
          console.log('âœ… ç®¡ç†å“¡æ¬Šé™é©—è­‰æˆåŠŸ');
        }
      }

      bindEvents() {
        document.getElementById('testConnection').addEventListener('click', () => this.testConnections());
        document.getElementById('startSync').addEventListener('click', () => this.startSync());
      }

      loadConfiguration() {
        // å¾ localStorage è¼‰å…¥é…ç½®
        ['site1', 'site2', 'site3'].forEach(site => {
          const config = localStorage.getItem(`${site}Config`);
          if (config) {
            const data = JSON.parse(config);
            document.getElementById(`${site}Name`).value = data.name || '';
            document.getElementById(`${site}Db`).value = data.db || '';
            document.getElementById(`${site}Key`).value = data.key || '';
            this.updateSiteStatus(site, 'success', 'å·²é…ç½®');
          }
        });
      }

      saveConfiguration() {
        ['site1', 'site2', 'site3'].forEach(site => {
          const config = {
            name: document.getElementById(`${site}Name`).value,
            db: document.getElementById(`${site}Db`).value,
            key: document.getElementById(`${site}Key`).value
          };
          localStorage.setItem(`${site}Config`, JSON.stringify(config));
        });
      }

      updateSiteStatus(site, status, message) {
        const statusEl = document.getElementById(`${site}Status`);
        statusEl.className = `status-badge status-${status}`;
        statusEl.textContent = message;
      }

      async testConnections() {
        this.addLog('é–‹å§‹æ¸¬è©¦é€£æ¥...');
        
        for (let i = 1; i <= 3; i++) {
          const site = `site${i}`;
          const name = document.getElementById(`${site}Name`).value;
          const db = document.getElementById(`${site}Db`).value;
          const key = document.getElementById(`${site}Key`).value;

          if (!name || !db) {
            this.updateSiteStatus(site, 'warning', 'é…ç½®ä¸å®Œæ•´');
            continue;
          }

          try {
            // æ¨¡æ“¬é€£æ¥æ¸¬è©¦
            await this.simulateApiCall(db, key);
            this.updateSiteStatus(site, 'success', 'é€£æ¥æ­£å¸¸');
            this.addLog(`âœ… ${name} é€£æ¥æ¸¬è©¦æˆåŠŸ`);
          } catch (error) {
            this.updateSiteStatus(site, 'error', 'é€£æ¥å¤±æ•—');
            this.addLog(`âŒ ${name} é€£æ¥æ¸¬è©¦å¤±æ•—: ${error.message}`);
          }
        }
      }

      async simulateApiCall(db, key) {
        // æ¨¡æ“¬ API èª¿ç”¨å»¶é²
        await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 2000));
        
        // æ¨¡æ“¬éš¨æ©ŸæˆåŠŸ/å¤±æ•—
        if (Math.random() > 0.8) {
          throw new Error('é€£æ¥è¶…æ™‚æˆ–èªè­‰å¤±æ•—');
        }
      }

      async startSync() {
        if (this.syncInProgress) return;
        
        this.syncInProgress = true;
        this.addLog('ğŸš€ é–‹å§‹åŒæ­¥æœƒå“¡æ•¸æ“š...');
        
        const progressEl = document.getElementById('syncProgress');
        const statusEl = document.getElementById('syncStatus');
        
        try {
          // æ¨¡æ“¬åŒæ­¥éç¨‹
          const steps = [
            'é©—è­‰æ•¸æ“šæºé€£æ¥',
            'æå–ç”¨æˆ¶åŸºæœ¬è³‡æ–™',
            'åŒæ­¥è¨‚å–®è¨˜éŒ„',
            'è¨ˆç®—ç©åˆ†è½‰æ›',
            'åˆä½µé‡è¤‡å¸³æˆ¶',
            'æ›´æ–°æœ¬åœ°æ•¸æ“šåº«',
            'é©—è­‰æ•¸æ“šå®Œæ•´æ€§'
          ];

          for (let i = 0; i < steps.length; i++) {
            statusEl.textContent = steps[i];
            progressEl.style.width = `${((i + 1) / steps.length) * 100}%`;
            this.addLog(`ğŸ“ ${steps[i]}`);
            
            // æ¨¡æ“¬è™•ç†æ™‚é–“
            await new Promise(resolve => setTimeout(resolve, 2000 + Math.random() * 3000));
          }

          statusEl.textContent = 'åŒæ­¥å®Œæˆ';
          this.addLog('âœ… æœƒå“¡æ•¸æ“šåŒæ­¥å®Œæˆ');
          this.loadStatistics(); // é‡æ–°è¼‰å…¥çµ±è¨ˆæ•¸æ“š
          
        } catch (error) {
          statusEl.textContent = 'åŒæ­¥å¤±æ•—';
          this.addLog(`âŒ åŒæ­¥å¤±æ•—: ${error.message}`);
        } finally {
          this.syncInProgress = false;
        }
      }

      loadStatistics() {
        // æ¨¡æ“¬è¼‰å…¥çµ±è¨ˆæ•¸æ“š
        const sites = [
          { name: 'ç¶²ç«™ 1', users: 1245, orders: 3567, points: 89234 },
          { name: 'ç¶²ç«™ 2', users: 892, orders: 2134, points: 45678 },
          { name: 'ç¶²ç«™ 3', users: 567, orders: 1456, points: 23456 }
        ];

        const tbody = document.getElementById('statsTable');
        sites.forEach(site => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${site.name}</td>
            <td>${site.users.toLocaleString()}</td>
            <td>${site.orders.toLocaleString()}</td>
            <td>${site.points.toLocaleString()}</td>
            <td>${new Date().toLocaleString()}</td>
            <td><span class="status-badge status-success">å·²åŒæ­¥</span></td>
          `;
          tbody.appendChild(row);
        });
      }

      addLog(message) {
        const logsEl = document.getElementById('syncLogs');
        const logItem = document.createElement('div');
        logItem.className = 'log-item';
        logItem.innerHTML = `
          <div class="log-time">${new Date().toLocaleString()}</div>
          <div>${message}</div>
        `;
        logsEl.insertBefore(logItem, logsEl.firstChild);
      }
    }

    // åˆå§‹åŒ–æœƒå“¡æ•´åˆç³»çµ±
    new MemberIntegration();
  </script>
</body>
</html>